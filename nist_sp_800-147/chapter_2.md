# 第 2 章 背景

诸如台式机和笔记本等现代计算机包含辅助硬件初始化过程的程序代码。该代码存储于非易失性存储器中，并且通常被称为启动固件。用于初始化系统的主要固件称为基本输入/输出系统（_BIOS_）或者 _系统 BIOS_。本章提供了关于系统 BIOS 及其在启动过程中的作用的背景信息并且使用传统 BIOS 和统一可扩展固件接口（UEFI）BIOS 作为范例。它识别了用于更新系统 BIOS 的主要方法，以及关于系统 BIOS 的安全问题和威胁。

## 2.1 系统 BIOS

当计算机加电时，系统 BIOS 是主要中央处理器（CPU）所执行的第一个软件。尽管系统 BIOS 最初负责为操作系统提供硬件访问，它在现代设备上的主要职责是初始化并测试硬件组件以及加载操作系统。此外，系统 BIOS 加载并且初始化重要的系统管理功能，诸如电源和散热管理。系统 BIOS 可能还会在启动过程中加载 CPU 微码补丁。

有若干种不同类型的 BIOS 固件。某些计算机使用 16 位的传统 BIOS，而众多较新的系统使用基于 UEFI 规范 \[UEFI\] 的启动固件。在此文档中，我们将所有类型的启动固件称为 BIOS 固件、系统 BIOS 或者简称为 BIOS。如有必要，我们将会通过将其分别称为传统 BIOS 和 UEFI BIOS 来区分传统 BIOS 固件和 UEFI 固件。

系统 BIOS 通常由原始设备制造商（OEM）和独立 BIOS 厂商开发，并且随计算机硬件分发到最终用户。制造商频繁更新系统固件以修复 bug、为漏洞打补丁以及支持新硬件。系统 BIOS 通常存储于电可擦除可编程只读存储器（EEPROM）或者其他形式的闪存中，并且可由最终用户修改。一般来说，系统 BIOS 固件通过使用某种对于 BIOS 所存储于其中的非易失性存储器组件拥有特别知识的工具来更新。

一台给定的计算机系统可能在若干不同的位置拥有 BIOS。除了主板以外，BIOS 可以在硬盘控制器、显卡、网卡和其他扩展卡中找到。这种额外的固件通常采用选项 ROM 的形式（包含传统 BIOS 和/或 UEFI 驱动程序）。它们在启动过程中由系统固件加载并执行。其他系统设备，诸如硬盘和光驱，可能拥有它们自身的微控制器和其他类型的固件。

如同 1.2 节所注释的那样，此文档中的指导意见适用于存储于系统闪存中的 BIOS 固件，这包括随系统 BIOS 固件一起保存并且由相同机制更新的选项 ROM 和 UEFI 驱动程序。它并不适用于存储于计算机系统的其他位置的选项 ROM、UEFI 驱动程序和固件。

## 2.2 系统 BIOS 在启动过程中的作用

系统 BIOS 的主要功能是初始化重要硬件组件以及加载操作系统，此过程称为启动。系统 BIOS 的启动过程通常在以下步骤中执行：

1. 执行核心可信根：系统 BIOS 可能包括一小块核心固件，它首先被执行并且能够验证其他固件组件的完整性。它在传统上曾经被称作 BIOS 启动块。对于可信计算应用程序，它还可以包含用于测定的核心可信根（CRTM）
2. 初始化并测试低级硬件：在启动过程的极早期，系统 BIOS 初始化并测试计算机系统中的关键硬件，包括主板、芯片组、内存和 CPU
3. 加载并执行额外组件模块：系统 BIOS 执行额外的固件，这些固件扩展了系统 BIOS 的能力或者初始化系统启动所必需的其他硬件组件。这些额外的模块可能存储于和系统 BIOS 相同的闪存中，或者可能存储于它们所初始化的硬件设备中（例如显卡、局域网卡等）
4. 选择启动设备：当系统硬件被配置后，系统 BIOS 查找一个启动设备（例如硬盘、光驱、USB 驱动器等）并且执行存储于该设备上的引导程序
5. 加载操作系统：在系统 BIOS 仍然控制计算机时，引导程序开始加载并且初始化操作系统内核。一旦内核开始发挥功能，计算机系统的主要控制权就从系统 BIOS 移交给操作系统。

此外，系统 BIOS 加载系统管理中断（SMI）处理程序（又称为系统管理模式（SMM）代码），并且初始化高级配置与电源接口（ACPI）表和代码。它们为运行着的计算机系统提供重要的系统管理功能，诸如电源和散热管理。

本章描述基于传统 BIOS 的系统以及基于 UEFI 的系统中的启动过程。尽管传统 BIOS 被应用于当今所部署的众多台式机和笔记本，业界已经开始过渡到 UEFI BIOS。

### 2.2.1 传统 BIOS 启动过程

图 1 展示了运行传统 BIOS 的 x86 兼容系统的一种典型启动过程。传统 BIOS 通常在 16 位实模式中执行，尽管某些后期的实现在保护模式中执行。某些基于传统 BIOS 的固件拥有一小块这样的 BIOS 固件——称为 BIOS 启动块——它在逻辑上同 BIOS 的其余部分相分离。在这些计算机系统上，该启动块是启动过程中最先被执行的固件。启动块负责检查其余 BIOS 代码的完整性，并且可能提供恢复机制，如果主板 BIOS 固件损坏。在大多数可信计算架构中，BIOS 启动块作为该计算机系统的 CRTM，由于此固件被隐含地信任，以便自举在本机上执行的其余固件和软件的后续验证的测定链的构建过程 \[TCG05\]。

启动块执行传统 BIOS 中用于初始化大部分硬件组件的那部分代码——加电自检（POST）代码。在 POST 过程中，计算机系统中的关键低级硬件被初始化，包括芯片组、CPU 和内存。系统 BIOS 初始化显卡，它可能加载并执行其自身的 BIOS 以初始化图形处理器及其内存。

> 图 1 传统 BIOS 启动过程（脚注 1）

> 脚注 1 此图基于可在 \[Duarte08\] 中找到的信息和示意图

接下来，系统 BIOS 查找其他外设和微控制器，并且执行这些组件上的任何必需的选项 ROM 以初始化它们。选项 ROM 在启动过程的非常早期被执行，并且可以为启动过程添加一系列特性。例如，网络适配器的选项 ROM 可以加载预启动执行环境（PXE），它允许一台计算机通过网络启动。

接下来，系统 BIOS 搜索计算机系统以查找已被标识为启动设备的存储设备。在通常情况下，BIOS 试图从它所找到的第一个拥有有效的主引导记录（MBR）的启动设备启动。该 MBR 指向存储于硬盘上的引导程序，它随之开始加载操作系统的进程。

在启动过程中，系统 BIOS 加载 SMI 处理程序并且初始化 ACPI 表和代码。SMI 处理程序在 CPU 上以一种特别的高权限模式运行，称为系统管理模式，这是一种 32 位模式，它可以跳过保护模式的众多硬件安全机制，诸如内存分段和页保护。

### 2.2.2 UEFI 启动过程

在较高层级上，如图 2 所示的 UEFI 启动过程遵循一种同传统 BIOS 启动过程相似的流程。区别之一是 UEFI 代码在 CPU 上以 32 位或 64 位保护模式运行，而非以传统 BIOS 中经常出现的 16 位实模式。大多数基于 UEFI 的平台始于一小块核心代码，它主要负责认证计算机系统上随后执行的代码。这与传统 BIOS 中的启动块的作用非常相似。这部分启动过程称为安全（SEC）阶段，并且作为计算机系统的核心可信根。

> 图 2 UEFI BIOS 启动过程

UEFI 启动过程的下一个阶段是前 EFI 初始化（PEI）阶段。PEI 阶段的本意是要初始化关键系统组件，诸如处理器、芯片组和主板。在某些情况下，安全阶段和 PEI 阶段的代码构成了 UEFI 系统中的核心可信根。

PEI 阶段的目的是为驱动程序执行环境（DXE）阶段准备系统。DXE 阶段是大部分系统初始化被执行的阶段。在此阶段执行的固件负责查找并执行那些在启动过程中提供设备支持或是额外特性的驱动程序。在此阶段中，UEFI BIOS 可能执行传统的选项 ROM，它们拥有相似的目的。

UEFI 启动过程的 PEI 和 DXE 阶段为加载操作系统奠定基础。加载操作系统的最后必要任务在启动设备选择（BDS）阶段中完成。此阶段为系统上的简单输入/输出操作初始化控制台设备。这些控制台设备包括本地文字或图形接口，以及远程接口，诸如 Telnet 或者基于 HTTP 的远程显示。BDS 阶段还会加载任何必要的额外驱动程序以管理控制台或者启动设备。最后，固件从首个 MBR 或者全局唯一标识分区表（GPT）格式的启动设备中加载引导程序，并且加载操作系统。

在启动过程中，UEFI BIOS 加载 SMI 处理程序并且初始化 ACPI 表和代码。

UEFI 启动过程的运行时（RT）阶段始于操作系统准备就绪以从 UEFI BIOS 接管控制权时。在此阶段中，UEFI 运行时服务对操作系统可用。

## 2.3 更新系统 BIOS

系统及其支持管理软件和固件可能提供若干种认证的机制以合理地更新系统 BIOS。这些机制包括：

1. 由用户触发的更新：系统和主板制造商通常会为最终用户提供能够更新系统 BIOS 的工具。在历史上，最终用户从外部介质启动以执行这些更新，但是今天大多数制造商提供了能够从用户的正常操作系统中更新系统 BIOS 的工具。取决于系统所实施的安全机制，这些工具可能是直接更新 BIOS，或是它们能够为下一次系统重启时安排一次更新
2. 受管理的更新：一台给定的计算机系统可能拥有基于硬件和软件的机制以允许系统管理员远程更新系统 BIOS 而无需同用户之间的直接交涉
3. 回滚：在应用更新之前对其进行认证的系统 BIOS 实现可能也会在更新过程中检查版本号。在这些情况下，系统 BIOS 对于将已安装的固件回滚到某个早期版本可能拥有一种特别的更新过程。例如，回滚过程可能要求用户的物理存在。这种机制防止了攻击者刷入带有已知漏洞的旧固件
4. 手动恢复：为了从损坏或者工作异常的系统 BIOS 中恢复，众多计算机系统提供机制以允许在启动过程中具有物理存在的用户以某种已知正常的版本和配置来替换当前系统 BIOS
5. 自动恢复：有些计算机系统能够检测系统 BIOS 于何时被损坏，并且从备份固件镜像中恢复，它存储于不同于主要系统 BIOS 的独立存储位置（例如，第二块闪存芯片、硬盘上的隐藏分区）。

## 2.4 BIOS 完整性的重要性

作为主 CPU 所执行的第一批代码，系统 BIOS 是计算机系统的重要安全组件。尽管系统 BIOS，有可能会用到可信平台模块（TPM），可以验证启动过程中随后执行的固件和软件的完整性，系统 BIOS 的全部或者部分通常是被隐含地信任的。

系统 BIOS 是一个潜在地对攻击者具有吸引力的目标。运行在 BIOS 层级的恶意代码可以拥有对于计算机系统的极大的控制权。它可以被用于攻击在启动过程中随后被加载的任何组件，包括 SMM 代码、引导程序、虚拟机监视器和操作系统。BIOS 存储于其内容在供电周期之间持续存在的非易失性存储器上。写入 BIOS 中的恶意软件可以被用于重新感染设备，即使是在安装了新的操作系统或者更换了硬盘之后。由于系统 BIOS 在设备上以极高的权限在启动过程的早期运行，运行在 BIOS 层级的恶意软件可能很难检测。由于 BIOS 首先被加载，反恶意软件的产品没有机会来具有权威性地扫描 BIOS。

可利用的 BIOS 漏洞像是高度系统具体化的——指向某个特定版本的系统 BIOS 或者特定硬件组件（例如，某种特别的主板芯片组）。与之相反，大多数以软件为目标的恶意软件在操作系统内核之中或其上运行，它在此处容易开发，并且可以攻击更大范围类别的设备。BIOS 层级的恶意软件更有可能被用于对高价值计算机系统的针对性攻击。迁移到基于 UEFI 的 BIOS 可能使得恶意软件以一种大范围的方式针对 BIOS 变得更容易了，由于这些 BIOS 实现基于通用的规范。

基于以上列举的原因，只有极少已知的 BIOS 层级恶意软件的实例。此时，唯一公开已知的曾经感染了数量可观的计算机的针对系统 BIOS 的恶意软件是 CIH 病毒，也称为切尔诺贝利病毒 \[Sym02\]，它最初被发现于 1998 年。此病毒的负载的元素之一试图覆盖那些使用当时被广泛部署的一种特定芯片组的系统的 BIOS。此恶意软件依赖的若干种漏洞在现代设备上已经不复存在。

安全研究人员已经展示了针对传统 BIOS 和 EFI/UEFI 固件的其他潜在攻击。概念验证已经被展示为允许向允许未签名更新的传统 BIOS 实现中插入恶意代码 \[SaOr09\]。其他研究人员已经在一种现代平台的 EFI BIOS 中发现缓冲溢出漏洞。尽管这种 EFI BIOS 在启动过程早期写保护固件，并且仅可向固件刷入签名更新，缓冲溢出允许研究人员通过在写保护应用之前执行固件更新包中的某个未签名部分以跳过安全更新过程 \[WoTe09\]。

诸如此类的漏洞可能会允许攻击者创建运行在系统的极高权限下的隐形恶意软件。系统 BIOS 在将计算机的控制权移交给操作系统之前加载 SMI 处理程序。写入 BIOS 的恶意代码可以修改 SMI 处理程序以创建能够以 SMM 运行的恶意软件 \[EmSp08\]。这将会赋予恶意软件针对物理内存和连接到宿主机的外设的不受限制的访问权，并且它将很难被运行在操作系统上的软件检测到。

## 2.5 针对系统 BIOS 的威胁

上述章节证实了维持系统 BIOS 完整性的重要性。本节描述系统 BIOS 完整性可能遭受攻击的一些不同方式，并且识别那些将会在第 3 章中所具体说明的安全控制和过程的范围中所考虑的那些攻击。

对系统 BIOS 的完整性的第一个威胁来自系统在供应链中运动时。供应链安全技术不在此文档所具体说明的安全控制范围之内。然而，3.2 节所具体叙述的某些程序可以被用于识别并且拯救那些拥有非授权的系统 BIOS 的系统。

假设系统自带的是制造商本意想要安装的系统 BIOS，在此系统的生命周期内，系统 BIOS 的完整性面临着各种威胁：

* 最难防止的威胁是由用户触发的恶意系统 BIOS 安装。由用户触发的 BIOS 更新工具通常是更新系统 BIOS 的首要方法。此文档所包含的指导意见并不能够防止用户安装未经许可的 BIOS 镜像，如果他们拥有对于计算机系统的物理访问。如同供应链威胁那样，安全过程可能能够检测并且清除未经许可的系统 BIOS，诸如引发恢复过程以恢复到一个经过许可的 BIOS
* 恶意软件可以撬动弱的 BIOS 安全控制或者利用系统 BIOS 本身的漏洞以重刷或者修改系统 BIOS。通用目的的恶意软件不太可能包含此功能，但是针对某一组织的攻击可以指向该组织的标准系统 BIOS。恶意 BIOS 可以通过网络或者利用介质而带到系统中。此文档中的指导意见被设计为防止此类攻击
* 基于网络的系统管理工具也可能被用于在组织范围内发动针对系统 BIOS 的攻击。例如，考虑一台由组织维护的用于该组织的已部署系统的 BIOS 更新服务器；一台被攻击的服务器可以向组织内的计算机系统推送恶意系统 BIOS。这是一种具有重大影响的攻击，但是需要一位局中人或者攻击该组织的更新过程。此文档所呈现的指导意见被设计为防止此类攻击
* 上述任何机制都可能被用于回滚到一种经过认证但是包含漏洞的系统 BIOS。这是一种特别隐秘的攻击，由于“坏的”BIOS 是经过认证的（即由制造商提供）。后续章节所具体说明的安全控制主要专注于验证系统 BIOS 的来源和完整性。此文档包含对于回滚保护的建议控制。

后续章节描述的控制主要专注于防止由运行在计算机系统上的潜在地具有恶意的软件进行的未经认证的系统 BIOS 修改。在供应链中、由拥有物理访问的个人，或是通过回滚到一个经过认证但是具有漏洞的系统 BIOS 等方式而进行的未经许可的系统 BIOS 安装并未被 3.1 节中的控制所解决，但是可以通过使用 3.2 节所具体说明的过程来解决。

