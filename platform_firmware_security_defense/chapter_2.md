# 第 2 章 针对固件的威胁

对于几乎每一类型的固件，都存在关于概念性的漏洞利用的例证。很多种类的固件漏洞的主动利用已经在公开领域被发现，并且其他一些已经在泄露的文档中被引用。随着固件的复杂度不断增加，可供利用的攻击面也在增大。操作系统尽管广泛存在漏洞，但是它们相对于固件更好地被系统管理员和安全专家所理解和保护。在某些案例中，常规的保护和现存的最佳安全实践仍然不足以对抗固件级别的攻击。

在几乎所有基于 Intel/AMD 的现代系统中，UEFI 取代了老旧的 BIOS。尽管曾经有过基于 BIOS 的攻击，它们通常需要一位对于它将要被应用于的目标 BIOS 和系统拥有相对深入的了解的攻击者以汇编语言编写。这种攻击不一定能够在目标系统和任何其他品牌或者型号的系统之间可移植，即使这些系统出自同一制造商。UEFI 是非常标准化的平台，使得众多厂商可以撬动一种称为 Tianocore（[https://tianocore.org](https://tianocore.org)）的强大的开源核心系统，它在很多方面就像一种发展完全的操作系统。数千行代码普遍存在于不同的 UEFI 实现中，其在不同系统之间的主要区别是标准化的模块，它们使用一种通用的 API，这在 UEFI 中称为协议（_protocol_）。可为 UEFI 编写的模块通常是用 C 语言编写的，但是 UEFI 也可支持若干种其他编程语言，包括 Python 甚至 Javascript，因此对于低级汇编语言的编程技能的需求较少。因此 UEFI 相对于 BIOS 呈现了大得多的攻击面。幸运的是，UEFI 经常与某些显著的安全性改进一同被实施，诸如安全启动。但是就像大多数安全性改进那样，诸如安全启动等技术为管理系统增加了额外的工作量，因此它们经常被禁用。

尽管 UEFI 是一个完全不同的案例，并且相对于其他系统固件明显更加标准化，某些相同的问题也适用于其他领域。ARM 和其他类似的微处理器的更低的成本、更高的可用性和能力使得对于内建于 PCIe 板卡、硬盘和固态硬盘的控制器而言，利用 C 语言或者更高级的语言进行构建来实现一种接口更加容易，通常也更加廉价。通常，固件可以从操作系统级别进行更新，允许就地修补而非返厂送修（RMA），但也会允许深度植入的恶意软件，始于操作系统级别的攻击。当然，只能由制造商更新的 ROM 并不能保证起到保护作用——由于可能会犯错，诸如将一台笔记本退还给错误的客户，此笔记本拥有诸如 _Computrace_（一种 LoJack 式的固件）这样的机密，对于它所涉及的另一位客户而言。

几乎所有固件，包括每一种正在生产中的 UEFI 版本，都包含闭源的已编译代码的二进制 blob，并且供应链上的几乎每一个步骤通常都会向完整的系统中添加额外的二进制 blob。很容易认为一台系统是来自一家特定的制造商的，但是即使它们真正地制造了这台系统，而非只是在其中加入它们的名字，通常也有一长串的原始设计制造商（_ODM_）和独立硬件厂商（_IHV_）位于原始设备制造商（_OEM_）的上游，而这还不算独立组件，诸如网络和硬盘控制器等的制造商。

如果您熟悉开源软件对于 bug 和安全透明性的原则，您不会在固件领域看到太多的透明性。带有安全性的启示的 bug 会被持续隐藏长得多的时间，并且恶意软件可以于二进制 blob 被添加的任何阶段被添加进来。

## 2.1 固件威胁的类型

在固件水平上，有可能执行几乎每一类在更高层级的软件领域可能更加为人们所熟知的攻击。在大多数直接的案例中，那些需要操作系统的恶意软件可以通过受到攻击的固件在操作系统运行时植入操作系统中，或者直接植入非易失性存储设备中。更为隐蔽的是，固件可以完全在操作系统以外运作——在存储设备（硬盘、固态硬盘等）中，固件可以在数据传入/传出存储设备的过程中将其损坏或者窃取，或者在外设中进行操作，在启用摄像头的同时使其指示灯保持为禁用状态。

以下所有这些范例，加上每一种额外的普通软件攻击，已经被发现能够影响固件：

* 竞争条件
* 缓冲区溢出
* 权限提升
* 语法分析错误
* 不当配置

### 2.1.1 Intel 分类法

Intel 于 Black Hat 2017 展示了固件安全话题，并且包括了一个很好的固件 bug 分类法——以及对于 bug 出现几率的评估。

尽管这些可以被看作标准软件 bug 的变体，从固件的视角将其考虑为特殊案例是有益的。此列表完全由 Intel 贡献：

* 不一致的电源状态过渡检查
* 无效的初始化状态（保存于内存中的机密，对于特定系统状态的猜测）
* S3 启动脚本
* 竞争条件
* 启用保护机制（包括禁用/启用特定硬件元素，包括错误的模块启动顺序）
* 检查时间/使用时间（TOCTOU）竞争条件
* 信任输入（来自平台中的较低权限实体，或者拥有由不同威胁向量配置的不同内容）
* 测定失败
* 未能测定某些模块
* 接受经过签名但适用于错误平台的更新，由于它们使用相同密钥
* 在错误的时间接受加载特定模块（此时某些内容未被适当地保护）
* 未能识别某种测定错误/问题
* 平台能力未恰当配置
* 未设置锁、设备未恰当地初始化、特性未被禁用等
* 安全或者有意义的内容暴露给不受信任的实体
* 例如 UEFI 变量
* 硬件不当行为
* 错误定义的架构、微架构、不良设计等
* 平台组件行为与规格说明不符

尽管 Intel 在构建此列表时主要考虑的是 UEFI，它可以同等程度地适用于系统上的任何固件。

## 2.2 固件威胁案例

### 2.2.1 Hacking Team 的 UEFI Rootkit

UEFI 极其强大。与 BIOS 相比，UEFI 拥有众多新增特性并且可扩展，这带来了相对于老旧的 BIOS 和小型启动固件大得多的攻击面。Hacking Team 在其文档于 2015 年被泄露时被发现拥有一种行之有效的攻击方法。Hacking Team 的攻击方法对于 Insyde 的 UEFI 实现是有效的，并且被发现需要对于目标机器的物理访问以启动进入 UEFI shell 并且加载攻击代码。此代码只是简单地注入（或者重新注入，如果需要）基于微软 Windows 的恶意软件，因此它对于非 Windows 操作系统不会奏效。然而，有证据显示 Hacking Team 曾经对攻击失败的案例提供支持，例如对于非 Insyde 实现的 UEFI。将其攻击代码移植到另一种 UEFI 实现对于 Hacking Team 这样的对手而言是一件相对简单的事情。如有必要，远程安装恶意软件可能也比较简单，这可能需要重启进入 UEFI shell，它有可能是由另一款恶意软件以 UEFI 更新的形式在操作系统内安装的。这种类型的攻击的主要目标是保证持续性，即使是在重新安装了操作系统的情况下。

### 2.2.2 BadUSB

通过 USB 的最明显的攻击方式就是一块带有自动运行文件或者其他恶意软件的闪存盘。当该文件被自动执行或者由用户打开时，该恶意软件便在应用程序层级上被植入操作系统。尽管更加复杂以及更具挑战性，存在多种从 USB 设备发动固件攻击的方式，考虑到对于攻击者而言，创建他们自己的驱动程序以骗过计算机有关该 USB 设备的功能的难易程度。诸如 Hak5 USB Rubber Ducky 这样的设备对于攻击者来说容易获得。

针对 USB 固件的攻击于 2014 年被展示，它们针对使用 Phison 控制器的设备。攻击者可以修改一块 USB 存储设备以使其如同一块 HID（键盘、鼠标等输入设备）那样运作，或者在该存储设备内部创建隐藏分区。这种攻击专用于 Phison 控制器，并且将会需要一位具有相似水平的技能的攻击者以构建一次针对其他 USB 设备的自定义攻击。

### 2.2.3 PCIe 和雷电的 DMA 攻击

将 PCIe 总线暴露给外部设备为具有物理访问的攻击者创造了一个新的攻击向量。一种专为此种类型的攻击而设计的通用设备称为 PCI Leech。当其被插入 PCIe 总线时，可以通过 DMA 直接从系统内存中窃取数据，或者修改该内存的内容以安插恶意软件。针对 Mac 的 Thunderstrike 攻击将会感染 PCIe 选项 ROM（_PCIe option ROM_）——存在于众多 PCIe 设备中的一块固件 blob。利用 Thunderstrike，攻击者可以感染一块特定的雷电设备，然后每当该设备被使用在一台新的系统上时，它将会感染新的宿主系统。

### 2.2.4 Equation Group 的硬盘固件攻击

将恶意软件安插到硬盘控制器的固件本身将会允许攻击者跳过磁盘加密，以及在磁盘或者固态硬盘读写数据时实时读取或者损坏数据。此技术也可用于注入操作系统层级的恶意软件，通过简单地感染一块可执行的在线磁盘。Equation Group 被发现曾经使用过此种攻击。

