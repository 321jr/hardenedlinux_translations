# 第 3 章 固件防护

## 3.1 理想解决方案

固件问题的终极解决方案是一个巨大的挑战。哪怕是单块主板的众多独立设计商和制造商都需要被说服以执行它，并且遵循最佳实践以及诸如 NIST 这样的组织的建议。如此做将会要求它们在一种剩余价值极低的业务模式中投入资金到系统开发中来。对于最终用户而言，固件拥有低得多的可见性，以及慢得多的更新周期。设计商和制造商同样需要将思维模式从历史性的闭源/二进制 blob 和知识产权保护转变到一种即使不是完全开源也应该更加透明的模式上来，出于可审计性的考虑。

某些专家，诸如 Invisible Things 的 Joanna Rutkowska 提议将固件从硬件中分离并且隔离开来，以使得它可以被跟踪更改，以及创建一种无状态计算机。

尽管如此之多的业界潮流反对进步，作为一名手握购买决定权以行使或者影响权力的系统管理员，您确实拥有能力以影响事物使其变得更好。事实上，如果那些影响大规模购买决定权的人们不争取进步，进步将肯定不会发生。

## 3.2 真实的解决方案

今天可供您使用的实践上的解决方案涉及到对您现有的实践方式进行修订，诸如硬件生命周期管理。在此领域中，安全性至今也没有得到多少关注，更不必说固件安全性。此外，有一些小范围的微调是可以应用于您很可能已经在执行的常规最佳安全实践的，以针对固件方面的考虑进行增补和调整。

下一章将会进行更加深入的介绍，并且在我们的尾注中，我们将会包括一个详尽（但是简洁）的检查列表以供您用于您的组织。

以下是关于开始思考这个问题的快捷但是不完整的概括：

* 当应用于固件时，遵循通常的最佳安全实践，包括：
* 锁定固件设置
    * 设置口令
    * 禁用不需要的服务（例如远程管理、PXE 等）
    * 启用安全启动——并且在大规模部署时考虑部署或者管理您自己的安全启动密钥
* 将固件添加到硬件生命周期
* 确保您正在购买您所能买到的最安全的硬件，基于其他限制条件（预算等）
* 在部署之前，锁定固件设置，转储并且计算散列值
* 当 IT 人员着手操作硬件时，检查并测试固件
    * 是否有必要的更新
    * 转储并计算散列值
    * 检查散列值
    * 使用 CHIPSEC、FWTS 及其他工具
* 在废弃处理之前，确保硬件已经被适当地抹除——包括固件，特别是存储于诸如 TPM 等位置的机密信息，更改固件口令以及安全启动密钥
* 遵循 NIST 对于固件的建议
* 使用 CHIPSEC、固件测试套件（FWTS）及其他工具

## 3.3 遵循最佳安全实践

作为一名 IT 专业人士，您很可能已经知道并且遵循比一般的非技术人士安全得多的最佳实践。这其中的某些可能完全不适用于固件——但是请记住，固件也是软件，并且通常是具有完整网络栈以及连续网络访问的软件。大多数现存的实践只需相对较少的逻辑性的修改就可以涵盖固件安全性。

下面的列表可能会遗漏某些项目并且作者将会欢迎那些可以整合到此书的未来版本中的建议。

我们的起点是这篇优秀的文章“保护固件免受攻击的 5 条提示”（_5 Tips for Protecting Firmware from Attacks_），其中带有来自 Eclypsium（之前来自 Intel 高级威胁研究（ATR））的 Yuriy Bulygin 和 John Loucaides 的输入内容，此外还有 NIST SP 800-147 标准。

### 3.3.1 理解并传播针对固件的威胁是真实存在的这一点：技术员工和管理教育

通过阅读本书，您将会比您的大多数同行更好地理解威胁。分享这本书，并且和您的同行以及经理分享您从中所学到的。最为紧迫的步骤是确保您了解您的系统所使用的哪种固件，并且以一种及时的方式更新制造商的固件升级，这将会需要您和 IT 及安全部门的合作与努力。

由于这些固件实现通常并不包括启用互联网的自动更新功能，这项任务落到了您身上。在大多数企业环境中，大量相同配置的机器使得这项任务变得容易了，但是跟踪固件版本和更新的可用性，并且部署它们仍然是一项繁重的任务。您已经有过管理操作系统和应用程序更新的实践，诸如保证更新以一种及时的方式被完全应用，尤其是当您允许用户延迟更新时。理想情况下，您可以在此过程中整合您的固件更新管理，如果不是实际的固件更新本身的话。

### 3.3.2 对固件进行宽泛的思考

记住，每一台现代计算系统的几乎每一个组件都包含固件。这不仅包括笔记本和服务器及其内建组件，诸如板载 WiFi 适配器或者硬盘等，也包括您可能将其完全视为外设的组件，诸如监视器等。记住包含那些并不严格属于计算机的计算设备，诸如交换机和路由器等。保持这样一种警觉性，即当今的几乎每一台电子设备都是某种形式的计算机，或者拥有与其相连接的某种形式的计算机。即使暂时还没有，很可能很快就会如此。

### 3.3.3 实践基本安全性

大部分固件只能在拥有物理访问或者 root/管理员权限的情况下进行更新。因此保护这些权限是至关重要的。遵循带有防火墙、沙盒、IDS/IPS 以及操作系统和应用程序更新的深度防护。

### 3.3.4 物理安全性

物理安全性就其自身而言是一整个独立的主题，自从人类农业起源之时就有其专业技能和知识。因此自然而然地有大量此类技能存在于信息技术世界以外。完全覆盖物理安全性，甚至只是在它涉及固件安全的情况下，也已经大大超出本书的范围。从根本上说，物理安全性是关于访问的——确保只有经过认证的个人拥有访问权，并且记录访问，不仅是那些认证过的个人的访问，甚至还包括非认证的个人的访问，例如在一次系统入侵中。

对于固件安全而言，物理访问是一个更加重要的方面，由于我们所讨论的众多类型的固件只能在拥有对包含该目标固件的机器的物理访问的情况下被修改。诸如通过主板上的 JTAG 端口，或者在重启过程中的控制台的物理存在。

#### 3.3.4.1 服务器的物理安全性

对于服务器的情况，物理访问通常是高度控制的，以符合最佳实践。如果没有，则存在诸多额外的理由使得固件安全经受物理安全性的检查批准。应当注意的是，物理访问保护是必要的，但对于服务器而言还不够，由于在大部分现代系统上，众多固件 ROM 可以直接被远程修改（在远程访问 IP KVM、IPMI、iLOM、BMC 和 Redfish 等案例中），而且更有可能是经过操作系统和操作系统层级的工具来间接修改。

#### 3.3.4.2 终端机的物理安全性

对于诸如台式机、笔记本和移动设备这样的客户终端系统而言，解决其物理安全性的问题看似不可能。然而，已有用于管理此类问题的最佳实践，并且在大多数情况下，在简单地遵循最佳实践的基础上仍有大量余地以进行改进，对于管理移动设备的物理访问，以及训练携带它们的人员。

关于终端机的固件安全性的最重要考虑是未知来源访问。最为明显的案例是经典的邪恶女仆攻击（_Evil Maid Attack_），其中一台遗留在酒店客房的无人值守的笔记本被一位装扮成酒店雇员的攻击者以物理方式访问。

在当今或是将来，旅行要求可能会鼓励或者要求人们将其笔记本放置在接受检查的行李中，这为机场安检以及行李搬运工提供了访问机会。即使您并不关注国家级别的威胁，某些国家可能会在边境或者旅行中鼓励或者协助企业间谍行为，以获取对于商业机密和知识产权的访问权，从而获得竞争优势。

对于终端机的标准安全建议，诸如：

1. 要求使用强口令
2. 使用强固件口令
3. 不要给予用户本地管理员权限
4. 使用全盘加密
5. 使用安全启动

并不足够，一旦一台笔记本被攻击者物理接触，所有这些假设都将不复存在。

还有一种更为隐蔽的版本称为“局中人下属”（insider affiliate）。由 Alice 所拥有的一台经常离开受到安全保护的公司办公环境的笔记本可能轻松地被朋友或者家庭成员访问而不被 Alice 所知，尽管她在绝大多数情况下保持了对该笔记本的物理访问权，并且不像在经典的邪恶女仆攻击的上下文中那样将其视为一台独自遗留在一个陌生位置的笔记本。这带来了几点重要的建议：

1. 总是保有大量经审查确认清洁（包括固件更新和安全扫描）的可供随时取用的笔记本，使得您不会由于这种轮换而过多地影响 Alice 的生产力
2. 开发并且持续改进笔记本轮换过程，使其保持尽可能高的效率
3. 考虑在每次出国旅行之后增加一次笔记本轮换
4. 使得针对更新和安全性的固件扫描成为任何移动式部署的一个常规部分，如同您对于病毒和恶意软件那样。每天一次甚至多次也不为过

Linux 基金会工作站安全性检查列表在此领域中会有所帮助，带有针对固件考虑的具体指导，并且其大多数建议可以同等程度地适用于其他操作系统。

#### 3.3.4.3 运输过程中的物理安全性

您可能会发现您自己需要运送任何类型的机器，包括服务器、笔记本、工作站、平板等。通常，这将会需要被快速办理，由于某些正当的商业理由。运输包装的物理破坏抵抗和检测是一项完善建立起来的技术。但是，值得对其进行某些思考，例如，如果您的企业通常运送的是整个货架的指尖陀螺，而您正在要求您的运输部门运送计算机设备。在运输过程中拦截硬件以植入间谍软件或者恶意软件是一种已知的攻击结构（称为“禁运”（_interdiction_））并且如果您使用全盘加密或者攻击者希望得到持久性，那么固件就是首选目标，特别是如果攻击者可以接触硬件足够长的时间以访问主板上的 JTAG 端口。因此运输之前的一整套固件更新、镜像提取和散列值计算的操作是合情合理的，还有对于以上相同元素的运输后验证。

### 3.3.5 黄金镜像（及其散列值）

这部分内容也许是您认为遗留在您安装操作系统的那段 IT 职业生涯中的东西，但是在固件领域，这仍然是高度相关的。某些固件实现可以被设计为或者期望为在其服务的生命周期内不会发生改变，即使它们的内容是可升级的，例如通过 JTAG 端口。制造商可能仅仅期望在保修送回时进行更新，或者例如只是将可升级性作为一种确保万无一失的特性。即使固件可以被期望进行相当频繁的更新，诸如 UEFI，它们拥有相当缓慢的更新周期，相对于您已经熟悉的操作系统和应用程序更新而言。

因此，在您初次购买时，为您的系统上的尽可能多的不同固件 ROM 制作黄金镜像以及当前级别（SHA256 或者更高）的散列值，并且周期性地在每一台设备上验证它们。注意，更改变量内容（例如 UEFI 中的启动设备顺序等）将会改变散列值。在现场使用中，此类更改应该不会非常频繁地发生，并且在理想情况下，制作黄金镜像及其散列值将会以至少相同的频率进行。这些镜像和散列值可以随同您已经保存的其他类似的可审计性的信息一同保存起来。

### 3.3.6 安全扫描

诸如开源项目 CHIPSEC、来自 Intel 的工具以及来自 Ubuntu Linux 的固件测试套件（_FWTS_）等工具允许对固件进行深度安全扫描。理想情况下，每一个品牌的基于 Intel 芯片和 UEFI 固件的系统都应该通过 CHIPSEC 中的每一项测试。作为一名系统管理员，使用您的购买杠杆以就这一问题向您的厂商施压，与此同时，您至少可以运行全部 CHIPSEC 测试，并且为每一台新系统记录信息，然后周期性地重复。您也可以利用您的 CHIPSEC 失败记录来影响未来的购买决策。

### 3.3.7 最终用户和非技术员工的教育

大多数企业当前并未对其员工进行起码足够的信息安全教育，但是移动设备的物理安全性是必需的。既然您当前的用户教育很可能确实需要改进，为何不包含某些关于物理安全性的训练呢？如果您的雇主事实上或者实际上要求员工将其笔记本带到工作单位以外，请确保并且强调一种“不加指责”（blameless）的方式来应对一起物理攻击事故——雇员们的工作要求他们的笔记本被非雇员接触并不是他们的过错。事故也是每个人学习如何改进安全性以及精炼您的事故响应计划的一次机会。同时，利用这次机会以宣传您的极低争执与快速的过程以将他们的可能受到攻击的笔记本轮换为完整功能的替代机。

### 3.3.8 将固件添加到硬件生命周期

将固件添加到硬件生命周期是固件安全中的远超其他方面的最为重要的组成部分。在 NIST SP 800-147 中详细描述的生命周期可以被用于增强您已有的硬件生命周期。当前的硬件生命周期通常和安全性只有很少甚至没有关系。对于传统硬件生命周期的关注焦点就是将硬件财产作为资产严加管理。在这里，至多只有一种关于跟踪财产的关注，包括如有可能就防止或者监测一台诸如笔记本的硬件财产于何时完全被盗，或是由于事故或者疏忽而丢失。即使是在被盗或者丢失的情况下，关于一笔昂贵财产的损失的关注可能会压倒其潜在的 IT 安全启示。

将固件安全性添加到硬件生命周期应该不会带来显著的额外工作量。最为重要的事情是为每一台全新的系统在其开箱之后的最早的步骤中制作黄金镜像并且计算散列值。在理想情况下，这些散列值将能够与制造商所提供的散列值进行比对，尽管当前制造商并不能可靠地提供散列值以供比对。在这样一个至关重要的节点上，捕获一条基线仍是可能的。在系统上安装或者配置软件之后，尤其是将该系统连接到网络之后，它就肯定不可能再用作基线。

下一步的精炼是在硬件的生命周期内的不同时间点添加固件检查。由于系统固件事实上是软件，在理想情况下，它应该以相同于操作系统和应用程序的频率被检查，很像反病毒软件。这对于大部分情况在当前并不可行，尽管 PreOS Security 的软件应该很快就能为此提供帮助。与此同时，为何不在一台系统从外部重新回到 IT 部门的控制范围时就添加固件重新转储和扫描的步骤呢？每当一台系统受到过物理访问攻击或者怀疑发生过一次攻击时都添加这些检查特别重要。

尽管关于固件安全性的新的关注可能会突出显示当前硬件生命周期过程中的问题，记住，硬件生命周期如同大多数 IT 过程与实践那样，总是可以改进，并且通过改进它往往还能得到其他好处。如果您的首席财务官最近还没有就财产跟踪问题打扰您，您将不会知道他（她）何时将会开始，也许您会迎来一位坚持要求在一夜之间就如此做的新任首席财务官。为何不现在就开始遵循更佳实践呢？

## 3.4 NIST 指导意见总结

在同业界的顶尖专家共同工作的过程中，NIST 提供了一些关于固件安全性的优秀指南。这些文档比本书长得多，但是我们试图为您提供一段实用的总结。对于将来的阅读，推荐您阅读这些文档中的每一篇的摘要和执行摘要。如果您将要从头到尾地阅读其中一篇，从最新的开始，以及全面但仍处于草案阶段的 NIST SP 800-193。

### 3.4.1 NIST SP 800-147：BIOS 保护指南

发布于 2011 年的 NIST SP 800-147 的总体关注焦点是普遍应用于 x86 和 x86\_64 PC 系统的老旧的 BIOS 固件。然而其建议可以被简单地延伸并且应用于任何平台固件，特别是那些允许就地更新的固件。

首先，BIOS 更新应该使用数字签名以防止安装不可信的 BIOS 升级镜像。其次，如果可能，可信的 BIOS 升级安装应该要求操作人员的物理存在。在 BIOS 内部或者周边应该存在完整性保护特性，以防止对 BIOS 进行无意或者恶意的更新，包括防止其他系统组件跳过认证更新机制。

此文档的关注焦点看起来完全是 OEM 和制造商，然而，保证所购买和使用的系统以这样一种方式与这些要求相兼容使得它们实际上能够被强制执行是系统管理员或者安全专业人士的责任。而系统操作人员也应该为将这些要求以这样一种方式整合进硬件生命周期负责，以使得例如 IT 员工能够足够经常地与移动系统进行物理接触，以便能够以一种及时的方式进行要求的更新。

### 3.4.2 NIST SP 800-147b：服务器 BIOS 保护指南

在 NIST SP 800-147 中，有关更加复杂的服务器的间隔由 NIST SP 800-147b 解决。这些更加复杂的服务器包括诸如带有服务处理器的刀片和网络设备，其每一个刀片及其机箱本身都拥有多级 BIOS 或者 UEFI 固件。作为简洁的总结，所有相同的保护措施都应当被应用到每一级，包括在每个系统组件之间阻止未经许可的更新。

### 3.4.3 NIST SP 800-155：BIOS 完整性测定指南

NIST SP 800-155 加入了可信根以及完整性测定的安全传输的概念。尽管此文档完全面向 OEM、操作系统厂商以及安全应用程序厂商，仍然值得理解系统的能力和限制，不论是从整体角度还是从您所管理的系统中所实现的角度。您可能还想理解这篇文档，以便就这些问题向您的系统厂商施压。

### 3.4.4 NIST SP 800-193：平台固件恢复能力指南

固件安全领域的最新文档，NIST SP 800-193，明确地概括了针对所有平台固件的讨论，并且包括了针对 OEM 和组件/设备提供商的指南，以保证所有系统固件都考虑并且实施了安全性的原则。再重复一遍——如果您将要只读一篇 NIST 指南，我们推荐您从 SP 800-193 开始。

