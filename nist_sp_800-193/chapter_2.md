# 第 2 章 平台架构

确保平台的固件代码和关键数据总是处于某种具有完整性的状态对于确保一台计算系统可以不受恶意软件困扰地运作至关重要。现代客户端和服务器计算系统可以看作分为两层高级架构，_平台_ 和 _软件_。出于此文档的目的，我们会将这两层逻辑架构的组合描述为系统。注意，图 1 只是示意性的，其本意并非为了表示平台中所有可能的设备，也不是为了表示任何特定设备的范例架构。在较高层级上，蓝色阴影方框中的项目是将要被视为平台的一部分的设备。

宽泛地说，_平台_ 是由将系统启动至软件和操作系统可以被加载的阶段所必需的硬件和固件构成的；_软件_ 是由加载操作系统以及操作系统随后处理的所有应用程序和数据所要求的元素构成的。注意，某些固件在软件启动之后继续执行。现存的业界最佳实践，以及诸如 NIST SP800-147，_BIOS 保护指南_ \[1\]、NIST SP800-147B，_服务器 BIOS 保护指南_ \[2\] 等 NIST 出版物已经着手应对保护平台的宿主处理器启动固件（传统上称为 BIOS，近来称为 UEFI \[3\]）（脚注 1）的完整性及其更新机制的问题，但是，保护只是网络弹性的三大关键元素之一（另外两个是检测和恢复）。此外，平台上的其他关键固件的弹性的解决程度并未达到宿主处理器启动固件的对应程度。尽管识别和定义包含固件的硬件的每一种类别和架构超出了此文档的范围，此文档适用于任何包含固件的平台中的设备，包括个人计算机、服务器、网络设备、智能电话、平板等。

> 脚注 1：出于此文档的目的，宿主处理器启动固件将会被一般性地指代传统基本输入/输出系统（BIOS）或者统一可扩展固件接口（UEFI）。

## 2.1 平台设备

如上文所述，平台是提供操作系统和应用程序所需的功能能力和服务的一系列设备。尽管作为一个整体的平台的弹性是终极目标，认识到平台是由众多不同设备构成的，并且通常是由不同厂商开发和制造的是至关重要的。基于此原因，此文档中的技术指导意见以面向独立平台设备的指导意见的形式描述。

为了描述具有弹性的平台，本节提供了通常对于平台的正常和安全运作至关重要的设备的列表。这些设备通常包含可变的固件，并且被此文档中的安全性指导意见的预想范围所覆盖。

然而，这不应该被视为每一种感兴趣的平台中的所有设备的完整列表。平台厂商需要仔细考虑那些应该被视为处于它们的特定平台范围中的其他设备。

在传统的基于 x86 的平台（台式机、笔记本、服务器、网络交换机）的情况下，这些设备标识于图 1 中，并且于下文定义。注意，这里的编号指的是用于在图 1 中标识这些设备的编号，其顺序并非为了指示任何优先级或者次序。

1. **嵌入式控制器（EC）/ Super I/O（SIO）**

    EC 通常与移动平台（笔记本、变形本、平板）相关联，而 SIO 通常与基于桌面的平台（台式机、基于桌面的工作站、一体机、瘦客户端）相关联。这并非普遍确切，但是通常足够确切以确定在某种类型的客户端系统中能够找到 EC 还是 SIO。EC 或者 SIO 通常控制平台中的诸如键盘、指示灯、风扇、电池监测/充电、散热监测等功能。此外，它通常是平台中的首个执行代码的系统板载设备，甚至会使得宿主处理器处于重置状态，直到 EC / SIO 准备就绪以允许宿主处理器获取它的首行宿主处理器固件代码。

2. **可信平台模块（TPM）**

    TPM \[4\] 是一块能够安全地存储和使用密码学密钥以及平台状态测定数据的安全协处理器。这些能力可以被用于在其他事物之中保护存储于系统上的数据、提供强壮的设备身份，并且验证系统状态。尽管并非所有平台都包括或者使用 TPM，在任何包括并且使用 TPM 的系统上，它的固件必须被保护，鉴于它在帮助确保平台的可信度方面的至关重要性。TPM 还包含非易失性存储器，它可以包含关键数据，并且如果是这样，它必须被保护。TPM 可以是独立的硬件设备，也可以被实现在平台的主机控制器或者其他微控制器所执行的固件中（后者有时被称为固件 TPM 或者 fTPM）。

3. **基板管理控制器（BMC）/ 管理引擎（ME）**

    BMC 与服务器平台相关联，而 ME 通常与客户端平台相关联。在这两种情况下，其功能的核心方面是作为一种带外管理设备，以允许管理员管理一个平台而无需要求宿主操作系统运行。尽管对于服务器或者客户端平台的基本计算功能而言并非总是严格必需，大多数现代服务器和客户端平台包含 BMC / ME，使得它们的固件不会对宿主处理器的安全域的完整性状态造成负面影响这一点至关重要。

4. **宿主处理器【又称为中央处理器（CPU）、应用处理器（APU）】**

    宿主处理器是通常平台中的处理单元，在传统上称为 CPU，现在有时也称为 APU 或者系统芯片（SoC）。这是主操作系统（和/或虚拟机监视器）以及用户应用程序所运行的处理单元。这是负责加载并执行宿主处理器固件的处理器。

5. **网卡（NIC）**

    不论是独立的还是作为 SoC 的一部分而集成的，大多数现代客户端和服务器平台拥有至少一块 NIC（有线或者无线），并且可能拥有多块，包括多种类型（有线、Wi-Fi、蜂窝）。尽管拥有一块 NIC 对于启动一个平台并非严格必需，在当今的互联世界中，在系统启动之后的某个时间点拥有某种形式的连接性是至关重要的。更为重要的是，受到攻击的 NIC 固件镜像可以作为对系统中的其他漏洞的利用的发射台，被用于窃取数据、作为中间人等。除了由微控制器运行的固件以外，NIC 可能还包含在启动过程中加载并且由宿主处理器执行的扩展只读存储器（ROM）固件。NIC 的扩展 ROM 固件同样受到保护是至关重要的。此扩展 ROM 固件可以同宿主处理器启动固件一同存储（对于集成 NIC 的情况），或者对于作为扩展卡的情况，可以独立存储于 NIC 本身。NIC 通常还包含关键数据，例如，介质访问控制（MAC）地址可能存储于可变存储器中。针对此关键数据的攻击可能导致针对此平台以及具有匹配的 MAC 地址的另一台系统的拒绝服务（DoS）。

6. **图形处理器（GPU）**

    GPU 是作为客户端平台中的主要“输出型”人体学接口设备（HID）的设备。在某些情况下，GPU 也可以被用作协处理器以支持高性能计算。GPU 可以作为对系统中的其他漏洞的利用的发射台。除了由微控制器运行的固件以外，GPU 可能包含在启动过程中加载并且由宿主处理器执行的扩展 ROM 固件。此扩展 ROM 固件可以同宿主处理器的启动固件一同存储（对于集成 GPU 的情况），或者对于作为扩展卡的情况，可以独立存储于 GPU 本身。

7. **串行外设接口（SPI）闪存**

    大多数现代平台包括一定数量的 SPI 闪存以存储固件，通常是用于宿主处理器的启动固件，尽管它也可被用于其他目的。

8. **A）用于大容量存储设备的主机控制器（HC）**

    对于大多数现代平台，需要有某种采用硬盘（HDD）或者固态硬盘（SSD）形式的本地大容量存储设备以启动操作系统并且存放用户的应用程序和数据。为了使得数据能够被存储到该大容量存储设备上，主机控制器（HC）被用于通过某种存储总线（例如 SATA、SCSI、PCIe）将数据从平台的主内存中移至物理存储介质中。HC 可以被集成到 SoC 中，也可以是独立的设备或者位于扩展卡上。

    **B）硬盘（HDD）/ 固态硬盘（SSD）**

    HDD 或者 SSD 代表了当前用于存储大量数据的传统平台中的最先进技术。这些设备与主机控制器（HC）相耦合。在 HDD 或者 SSD 内部，微控制器及其相关联的固件被用于执行将数据从平台的主内存发送至大容量存储设备的实际存储操作。对 HDD 或者 SSD 的固件的攻击同样可以用作对系统中的其他漏洞的利用的发射台，也可以被用于攻击用户和/或平台数据。

9. **嵌入式多媒体存储卡（eMMC）/ 通用闪存存储（UFS）**

    eMMC 和 UFS 作为移动系统的标准大容量存储设备而出现。它们中的每一种都可以包含它们自己的扩展 ROM 固件和/或带有与之相关联的固件的微控制器。

10. **宿主处理器启动固件**

    在大多数现代平台中，宿主处理器启动固件包含在 SPI 闪存设备中。BIOS 和统一可扩展固件接口（UEFI）是此类固件的范例。

11. **平台运行时固件**

    除了启动固件以外，还有平台运行时代码。此代码在平台启动以后仍然驻留在内存中并且可执行。这对于在系统完全运行时需要执行固件以执行某些功能的微控制器而言最为常见。被看作运行时代码的宿主处理器固件的一个范例是系统管理模式（SMM）代码。

12. **电源**

    某些电源拥有它们自己的微控制器和与之相关联的固件。通常的电池架构还包括内部逻辑和固件以管理该电池的充放电行为。

13. **粘合逻辑（CPLD、FPGA）——_未在图中显示_**

    现代嵌入式系统使用可编程的逻辑组件以提供粘合逻辑功能。有两种类型的可编程逻辑组件，称为 FPGA 的现场可编程逻辑门阵列和称为 CPLD 的复杂可编程逻辑器件。FPGA 通常在加电时通过比特流程序从所连接的闪存设备中加载。而 CPLD 由比特流进行一次编程并且保持其功能，直到在现场被再次编程。通常，此功能是系统的基本操作所需要的，如果损坏，可能导致平台的永久拒绝服务。

14. **风扇——_未在图中显示_**

    某些风扇拥有其自身的微控制器及其相关联的固件。

## 2.2 平台设备中的代码和数据

上述设备通常在其非易失性存储器中拥有某些固件和数据的组合，它们可以驻留在设备本身，或者位于共享存储设备（例如 SPI 闪存）。本节描述固件代码和数据，并且简要讨论此文档与这些组件相关的范围。

### 2.2.1 代码

固件代码是由任何设备的处理单元所使用以执行由设备所要求的操作的指令的集合。在历史上，平台设备中的固件极少在现场被修改，尽管系统或者组件厂商可以开发固件更新以便为漏洞打补丁、修复 bug 或者添加新功能。随着固件的复杂度增加，固件更新变得更加普遍，而硬件和操作系统厂商提供工具以帮助管理员更新他们的固件。

由于固件在很大程度上驱动着设备的行为，使其在平台上保持处于可信状态至关重要。针对固件代码的攻击可能使得设备不能运行，或者向设备中注入恶意功能。固件应该仅从授权的来源加载，通常是系统或者平台设备的制造商。

此文档中的指导意见描述了通过利用数字签名验证更新来保护固件的机制。它们还描述了检测针对固件的非授权修改的机制以及安全恢复的方法。

### 2.2.2 数据

数据是平台固件代码用以执行其操作的信息片断，如同其代码所指示。数据可以进一步分为关键和非关键。关键数据包括配置设置和策略，它们需要处于有效状态以使得设备维持其安全状态。非关键数据包括所有其他数据。

#### 2.2.2.1 关键数据

关键数据可以被用于不同目的，包括：

* **配置设置**：这些数据告知代码如何配置设备的操作方面
    * _范例_：启用某个被企业安全策略禁止的外设
    * _范例_：硬盘中的不可用扇区表
* **策略**：这些数据告知代码选择何种路径或者如何响应
    * _范例_：系统的启动顺序描述了尝试用于启动的有效设备及其顺序
    * _范例_：UEFI 安全启动，一系列安全性配置以控制 BIOS 将控制权移交给哪些第三方代码

关键数据难于精确定义，由于对于某一设备可能属于关键的数据对于其他设备可能并非关键。然而，关键数据的共同特征包括：

* 它必须处于有效状态以允许设备的正常启动和运行时操作
* 它在加电周期之间持续存在（例如存储于非易失性存储器中）
* 它会改变设备的行为或者功能
* 它必须处于有效状态以支持平台固件及其相关联的数据的保护、检测和/或恢复

某些关键数据被硬编码到代码中，并且仅可通过固件镜像更新而更新。出于此文档的目的，硬编码的数据被看作代码的一部分，并且根据固件代码的保护、检测和恢复指导意见来保护。

平台设备通常拥有在其正常操作时可由平台管理员、硬件、固件或者软件配置的其他数据。由于关键数据的损坏可能影响系统的正常或者安全运作，保护关键数据防止损坏，并且能够在检测到问题时进行恢复是至关重要的。然而，对于某些形式的关键数据的强保护可能在架构上难于实现，由于这样一些期望，即诸如操作系统以及设备驱动程序等某些实体拥有更改这些设置的访问权限。

某些配置数据只能通过由平台层级的代码控制的限定的接口来更改，例如，UEFI 运行时变量属于此类。这一基本层级的保护可以防止攻击者直接修改配置数据，并且允许平台固件在将更改提交至存储设备之前验证其输入。然而，某些实体可能能够利用这些限定的接口来作出格式良好但却是恶意的配置更改。

为了防止这样的破坏，针对某些特别敏感的配置数据的更改可以要求在使用上述限定的接口应用更改之前通过授权。在某些情况下，诸如宿主处理器启动固件或者服务处理器固件等平台设备可能能够先于允许平台管理员作出更改对其进行认证。其他认证技术可以允许平台固件对更改的来源和完整性进行密码学验证。

某些关键数据由不会通过外部接口暴露为可编程的固件管理（例如耗损平均技术数据），并且如果丢失或者损坏，可能导致设备功能永久丧失。此类状态数据需要在最高层级进行保护，并且不可从平台的其他位置写入。

#### 2.2.2.2 非关键数据

非关键数据可以被用于不同目的，包括：

* **信息性 / UI**：这些数据仅是信息性的，或者用作最终用户的用户界面（UI）的一部分
    * _范例_：在启动过程中显示名为“Property of NIST”的财产标签
* **状态**：不会影响平台完整性的状态设置
    * _范例_：系统启动时的数字锁定键的状态；BIOS 执行快速启动还是标准启动

非关键数据对于平台的安全启动或者操作不应该具有决定性。在实践中，所有由平台固件消费的数据都可能是安全敏感的，包括某些并不直接影响平台的正确和安全操作的数据。由平台固件消费的任何数据的错误或者对其的恶意攻击都可能暴露并且利用该代码中的漏洞。就其本身而言，对于由平台消费的任何非可信输入或者数据需要给予特别的关照。

