# 第 6 章 HY-BF4 安全性建议

## 6.1 VM 镜像管理

由于基于 VM 的软件（例如客户 OS、中间件和应用程序）利用虚拟机监视器软件共享虚拟化的宿主的物理内存，并不令人惊讶的是，VM 是所有指向虚拟机监视器的攻击的最大来源。在操作中的虚拟化环境中，VM 很少是从头构建的，而是从 VM 镜像构建。VM 镜像是用于创建运行着的 VM 版本的模板。某个组织机构可以拥有其自身的判据以便在其 VM 库中对其使用的不同 VM 镜像进行分类。一些常用的判据包括：处理器负载（用于计算密集型应用程序的 VM）；内存负载（用于诸如数据库处理等内存密集型应用程序的 VM）；以及应用程序敏感度（运行使用关键任务数据的关键任务应用程序的 VM）。对于每一种 VM 镜像类型，必须遵循下列实践以保证所得到的运行中的 VM 是安全的：

* 对于每一种 VM 镜像类型的黄金镜像文档。黄金镜像是由一组与 VM 镜像相关联的配置变量定义的。这些配置变量至少应该包括：客户 OS 厂商、版本、补丁级别、创建日期、vCPU 内核数量，以及内存大小等
* VM 镜像库中的每一个 VM 镜像必须带有与之相关联的数字签名
* 对 VM 镜像库的访问权限必须通过某种强壮的访问控制机制加以控制
* 对存储 VM 镜像的服务器的访问应该拥有安全协议

与上述实践相关联的安全性建议如下所述：

_安全性建议 HY-SR-9_：必须为所有类型的 VM 定义黄金标准，并且不符合此标准的 VM 镜像不应该被允许存储到 VM 镜像服务器或者库中。VM 镜像库中的镜像应该被周期性地扫描以查找过时的 OS 版本和补丁，这可能导致偏离标准

_安全性建议 HY-SR-10_：存储于镜像服务器中的每一个 VM 镜像应该带有数字签名以作为合法性和完整性的标识，利用可信、强壮的密码学密钥签名

_安全性建议 HY-SR-11_：向 VM 镜像库中迁入或者从中迁出镜像的许可应该通过某种强壮的访问控制机制强制实施，并且限制在一组授权的管理员中。如果没有访问控制机制，VM 镜像文件应该存储于加密设备中，该设备只能由一组限定的授权管理员利用具有足够复杂度的口令打开或者关闭

_安全性建议 HY-SR-12_：对存储 VM 镜像的服务器的访问应该总是通过安全协议，诸如传输层安全性协议（TLS）

## 6.2 VM 即时迁移

即时迁移是一种存在于所有虚拟机监视器中的功能，它允许某个 VM 被从一个虚拟化的宿主上迁移到另一个上，而其上的客户 OS 和应用程序仍然在运行。此功能提供了如下的关键优势：容错性、负载均衡，以及宿主维护、升级和补丁。在即时迁移中，源宿主上的客户 OS 的状态必须被复制到目标宿主上。这要求迁移内存内容、处理器状态、存储（除非两个宿主共享同一存储）以及网络状态

大多数虚拟机监视器所采用的最常见的内存迁移技术称为 _预复制_。在此方式中，属于 VM 的内存页被传输到目标宿主，而此 VM 继续在源宿主上运行 \[5\]。在迁移过程中被修改的内存页被再次发送至目标以保证内存一致性。在此阶段中，VM 上的当前正在操作中的所有处理器寄存器的精确状态也被传输过去，并且正在迁移中的 VM 在源宿主上挂起。目标的处理器寄存器被修改以复制源的状态，并且新迁移的 VM 恢复其操作。存储迁移由这样一种特性提供，它允许管理员将 VM 的文件系统从一个存储位置移动到另一个，而没有停机时间。这种存储迁移甚至可以发生在没有 VM 迁移的情况下，例如，某个 VM 可以继续在宿主服务器上运行，与此同时，构成此 VM 的文件在存储阵列或者逻辑单元号（LUN）之间移动。

在上述过程中，内存和处理器状态迁移功能是虚拟机监视器设计的内在方面，而存储迁移功能是存储管理的组成部分，并且适用于虚拟化和非虚拟化的基础设施。网络状态在 VM 迁移之后得以维持，由于每个 VM 带有其自身的独特 MAC 地址，并且迁移过程为迁移目标施加了某些限制（例如源和目标宿主应该位于相同的 VLAN 中）。因此，从安全维护的角度来看，唯一需要考虑的方面就是迁移过程的适当认证和安全的网络路径。

_安全性建议 HY-SR-13_：在 VM 即时迁移过程中，必须使用安全认证协议；执行迁移操作的管理员的凭证只被传输至目标宿主；内存内容和处理器状态的迁移通过安全网络连接进行；并且一个专用虚拟网段被同时用于源和目标宿主以承载此流量

## 6.3 VM 监视与安全策略强制实施

由于 VM 是针对虚拟机监视器的威胁的主要来源，针对 VM 状态和这些 VM 的出入流量的不间断监视是必要的，对于：(a) 控制流量类型，(b) 入侵检测和预防，以及 (c) 检测病毒和其他恶意软件。此功能可以通过两种方式实现：

* 基于 VM 的安全监视和介入解决方案
* 在 VM 或者虚拟网络对象（即虚拟交换机的端口/端口组）层级上的由具有流量规则强制实施功能的虚拟机监视器模块实现的安全监视和介入

在基于 VM 的安全监视和介入的方式中，软件或者软件代理（即安全工具）运行在某个 VM 之中以监视安全相关事件。此方式类似于运行基于宿主的 IDS。此方式的优势在于它对于运行在 VM 之中的代码提供了良好的可视性和上下文分析。然而，由于依赖底层客户 OS 上的安全工具，任何针对后者的攻击也会破坏此安全工具的功能，因此破坏这种反制措施。将安全工具作为可视化负载运行的另一个缺点是它对于其自身以及该 VM 上运行的其他应用程序负载的性能影响。

_基于虚拟网络的安全监视_ 可以有两种形式：

* (a) 用于保护每一个 VM 的专用安全设备
* (b) 运行在虚拟网络中并且能够保护虚拟机监视器宿主中的多个 VM 的安全设备

专用的安全设备在虚拟网络中被部署在被监视的 VM 之前，并且监视出入该 VM 的全部流量。此方式的主要缺点是，如果该 VM 被迁移至其他物理宿主，此专用设备也必须被迁移。

部署在虚拟网络上并且被配置为监视多个 VM 的通用安全设备可能必须被不间断地重新配置，由于下列原因：

* 被监视的该组 VM 总是不间断地处于某种状态流中，由于 VM 会被从一个虚拟化的宿主迁移到另一个，由于负载均衡、性能，甚至是安全性的原因
* 如果虚拟局域网（VLAN）被用于在 VN 之间提供通讯层级的隔离，VLAN 的配置可能随着 VM 上的负载结构偏移而发生持续的更改，着可能要求重新配置网络流量镜像能力以保证所有虚拟网络流量流经影响着该虚拟化的宿主上的负载的总体性能的监控工具

在基于虚拟机监视器的安全监视解决方案中，监视并保护 VM（用户 VM）的安全工具运行在托管业务应用程序的 VM 之外，而是在某个安全加固的特殊 VM 中。被设计并且配置为运行在此种模式下的安全工具称为安全虚拟设备（SVA）。SVA 通过虚拟机监视器中的 _虚拟机自省_ API 获得对于 VM 状态（例如 CPU、寄存器、内存和 I/O 设备）以及虚拟机之间、虚拟机和虚拟机监视器之间的网络流量的可视性。这是理想的解决方案，由于：

* (a) 它不易受到客户 OS 中的瑕疵的攻击
* (b) 它独立于虚拟网络配置，并且每当虚拟网络配置由于 VM 迁移或者驻留于该虚拟机监视器宿主上的 VM 之间的连接性的改变而发生改变时，不必须重新配置它

因此，对于为了保护虚拟机监视器而创建的 VM 监视解决方案的安全性建议如下所述：

_安全性建议 HY-SR-14_：应该存在机制以用于安全监视、VM 操作安全策略强制实施，以及检测 VM 中运行的恶意进程和出入 VM 的恶意流量。此监视和强制实施机制构成了用于构建杀毒（AV）和入侵检测及防止系统（IDPS）解决方案的基础

_安全性建议 HY-SR-15_：用于 VM 的安全监视和安全策略强制实施解决方案应该基于 VM 外部，并且撬动虚拟机监视器的虚拟机自省能力。通常，这样的解决方案涉及在安全加固的或者可信 VM 中运行诸如安全虚拟设备（SVA）的安全工具

_安全性建议 HY-SR-16_：运行于虚拟机监视器宿主中的所有反恶意软件工具（例如查毒软件、防火墙和 IDPS 等）应该拥有能力以执行基于一定周期的自主签名或者索引文件更新

## 6.4 VM 配置管理

每一个 VM 的配置都应该被监视和管理，贯穿其生命周期。在大多数案例中，除了虚拟机监视器自带的原生特性以外，这还可以通过利用专用的第三方工具来实现。这些工具的理想特性以安全性建议的形式提供如下：

_安全性建议 HY-SR-17_：VM 配置管理工具应该具有能力以编译日志并且警示管理员，如果在被监视的任何 VM 中检测到配置更改

## 6.5 用于 VM 管理的精细粒度管理权限

拥有能力以对虚拟化的基础设施指认精细粒度的管理权限使得建立不同的管理模型及其相关授权机制成为可能。为了展示对于粒度许可的要求，检视用于虚拟化的基础设施中的管理操作的一些应用案例场景是有帮助的：

* _VM 管理应用案例 1_：某个质量保证团队想要设置少量具有某些限定特性（诸如内存、CPU 等资源限额）的虚拟机以测试某些即将进入生产的应用程序。在此情况下，出于测试目的，在质量保证团队中专门指派一位或者更多位管理员以被授予特定的虚拟机设置的管理权限可能会有用
* _VM 管理应用案例 2_：某位被指派了确定不同虚拟化的服务器上的操作负载和对额外的虚拟化的宿主的需求的任务的性能规划者可能需要权限以查看每一个虚拟化的宿主中的虚拟机的列表，而非需要对这些 VM 执行任何管理操作的权限。在此情况下，拥有能力以授予对于虚拟化的宿主中的 VM 列表的查看权限，但是拒绝此用户与任何可见的对象的交互的权限是理想的
* _VM 管理应用案例 3_：在具有不同敏感度等级的 VM 运行于同一虚拟化的宿主之上的虚拟化的数据中心中，某位在虚拟机监视器层级被授予管理权限的管理员有时应该被禁止访问某个特定 VM，由于运行在该 VM 上的负载（即应用程序集合）的敏感性本质。在此情况下的理想能力是对于某个特别的子对象，拒绝其通过继承获得的权限
* _VM 管理应用案例 4_：在某些情况下，对一组为某个特定组织分部或者部门控制一系列 VM 的管理员指认权限是必需的。此类管理实体的必然结果是对于一类想要管理运行着某种特定类型的负载（例如网络服务器）的 VM 的管理员的需求，无论其在组织结构中的位置。此类管理员可能并不要求对于某个 VM 的全套管理功能，而只是某些管理功能的任意集合，诸如配置 CD 介质、配置软盘介质、控制台交互、设备连接、开机、关机、重置，或是挂起等。此场景要求具有能力以创建自定义功能，即它可以包括与某个 VM 相关联的权限的任意集合，也需要具有能力以创建自定义对象，即它可以包括运行某种特定类型的负载（例如网络服务器）的 VM 的任意集合

综合所有 4 种管理场景中的能力要求，关于必需的权限粒度的总体安全性建议如下所述：

_安全性建议 HY-SR-18_：用于 VM 管理的访问控制解决方案应该拥有粒度能力，既在权限授予层级，也在对象层级（即对于权限目标的具体说明可以是单一 VM 或者任何 VM 的逻辑组合，基于功能或者位置）。此外，还应该存在这样的能力以禁止对于某个 VM 组（例如运行具有特定敏感度等级的负载的 VM）中的某些特别对象的权限，尽管其拥有对于该 VM 组的访问权限

