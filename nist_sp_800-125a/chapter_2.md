# 第 2 章 开发安全性建议的方式

开发针对诸如虚拟机监视器的复杂软件的部署和使用的安全性建议需要对于潜在威胁的了解，这些威胁一旦被利用，将会影响虚拟机监视器功能的机密性、完整性和可用性这 3 种安全属性。此文档中用于开发针对虚拟机监视器的部署的安全性建议的方式如下所述：

* 保证虚拟机监视器平台的所有组件的完整性，从宿主的基本输入/输出系统（BIOS）到虚拟机监视器的所有软件模块。这可以通过第 3 章作为 HY-SR1 而列出的安全启动过程来实现
* 识别典型虚拟机监视器平台中的威胁来源。简要讨论了来自恶意或者受到攻击的 VM 的威胁的本质（2.1 节）
* 对于 5 种基线功能 HY-BF1～HY-BF5 中的每一种（除了 HY-BF3，由虚拟机监视器执行高权限操作以外），识别每一种功能之下的不同任务，并且对于每一种任务，识别对于该任务的安全执行的潜在威胁。那些能够提供担保以对抗这些威胁的利用的反制措施构成了安全性建议的基础（2.2 节）

必须注意到的是，在某些大型开源和商业软件环境的案例中（例如数据库管理系统（DBMS）平台），用于安全部署和使用的方式是研究发布于公开漏洞数据库中的关于不同产品供应的报告，通过在线公开论坛或者软件厂商查找可用的补丁，并且查找建议的安全配置设置（同样通过在线公开论坛或者软件厂商的网站）。我们并未在此文档中采用此方式，由于此文档本意中的目的并非为某个特定的开源或者商业虚拟机监视器产品供应提供安全性建议，而是为整个产品类型基于其基线功能提供安全性建议。

## 2.1 虚拟机监视器平台的威胁来源

虚拟机监视器软件驻留在连接到企业网络的物理宿主上，它拥有被远程管理的能力。与此同时，它支持多个通常是该物理宿主内部的软件定义的虚拟网络结点的虚拟宿主（虚拟机或者 VM）。在某些情况下，它们可以是隔离网络的结点或者共享宿主网络。基于这一场景，某人可以识别针对虚拟机监视器平台的 3 种基本威胁来源，每一种均由符号 HY-TS\# 标识：

* HY-TS1：来自或者通过虚拟机监视器（虚拟化的宿主）所驻留于其中的企业网络的威胁
* HY-TS2：通过诸如共享虚拟机监视器内存以及虚拟机监视器宿主内部的虚拟网络等信道，产生自恶意或者受到攻击的 VM 的威胁
* HY-TS3：来自网络接口，面向 VM 管理守护进程和虚拟机监视器管理控制台的威胁

来自来源 HY-TS1 和 HY-TS3 的威胁普遍存在于所有服务器级别的软件，并且在其他 NIST 文档中被良好地认识和应对。而来自来源 HY-TS2 的威胁是由虚拟机监视器所定义的虚拟化环境所特有的。我们将会在下一节中审视来自 HY-TS2 的威胁的本质。

虚拟机监视器控制着 VM 对物理硬件资源的访问，并且在 VM 之间提供隔离。VM 对诸如 CPU 和内存的硬件资源的访问由虚拟机监视器直接控制，而对于诸如网络和存储设备等资源的访问则是通过驻留于内核模块或者高权限 VM（即管理 VM）中的模块（驱动程序）来控制的。VM 之间的网络隔离是通过为每个 VM 指认一个独特的网际协议（IP）或者介质访问控制（MAC）地址、定义虚拟局域网（VLAN）或者覆盖网络并且为每个 VM 指认适当的网络标识符的方式来提供。来自恶意或者受到攻击的 VM 的威胁的本质可以通过以下方式来表明：

注意，每一种威胁由符号 HYP-T\# 来进行标识，其中 HYP 表示虚拟机监视器，T 表示威胁，\# 表示序号。

* _进程隔离突破——VM 逃逸（HYP-T1）_：来自恶意 VM 的针对任何虚拟机监视器的主要威胁。恶意 VM 成功地破坏了由 VMM/虚拟机监视器提供的对于诸如内存页和存储设备等硬件资源的隔离功能。换言之，恶意或者受到攻击的 VM 可以访问属于虚拟机监视器或者其他 VM 的内存区域，以及它们未被授权访问的存储设备。此类威胁的可能原因包括：(a) 虚拟机监视器的设计漏洞，或者 (b) 恶意或者易受攻击的设备驱动程序。由恶意 VM 获得虚拟机监视器的控制权带来的潜在下游影响包括安装 rootkit 或者对于同一虚拟化的宿主上的其他 VM 的攻击
* _网络隔离突破（HYP-T2）_：针对隔离的潜在威胁包括诸如由恶意 VM 进行的 IP 或者 MAC 地址伪造以及流量窥探，或者旨在针对同一虚拟网段上的 VM 的虚拟网络流量的拦截等攻击。对这些网络控制的破坏所造成的影响是机密性的丧失。某些 VM 将会能够查看它们并未被授权查看的信息
* _拒绝服务（HYP-T3）_：配置不当的或者恶意 VM 可能会消耗不成比例的高百分比的宿主资源，导致对于该虚拟机监视器宿主上的其他 VM 的拒绝服务

## 2.2 针对虚拟机监视器的基线功能的潜在威胁

本节检查了虚拟机监视器的 5 种基线功能（除了 HY-BF3 以外）中的每一种的每一项任务，并且对于针对这些任务的安全执行的威胁通过与上一节中标识出的原因进行关联以加以分析。

### 2.2.1 _针对 HY-BF1 的潜在威胁_

针对虚拟机监视器的 HY-BF1 功能（VM 进程隔离）的主要威胁是进程隔离突破（HYP-T1）。如 2.1 节所述，造成此威胁的原因之一是虚拟机监视器的设计漏洞。适用于此威胁的某些潜在设计漏洞在这里加以讨论，并且带有对于它们所可能表现出来的上下文环境的解释。每一种漏洞以符号 HYP-DV\# 标识，其中 HYP 表示虚拟机监视器，DV 表示设计漏洞，\# 表示编号。

* _虚拟机控制结构（HYP-DV1）_：为了适当地计划某个独立 VM 的任务（即由于每个客户 VM 被分配给一组虚拟 CPU（vCPU），它们称为 vCPU 任务），寄存器状态必须被适当地处理。为了允许保存和加载每个 vCPU 的状态，虚拟机监视器使用一种称为虚拟机控制结构（VMCS）的数据结构。对此数据结构的错误实现已知能够导致虚拟机监视器内存泄漏
* _处理敏感指令（HYP-DV2）_：在不提供虚拟化辅助的硬件平台上，应该有一种软件机制以发现敏感或者关键指令，将其发送至 VMM（虚拟机监视器），并且在硬件执行它们之前，利用诸如二进制翻译等技术将其替换为较为安全的指令。未能捕获关键指令或者错误翻译中发生的任何错误都可能拥有其形式为客户 OS 被允许执行高权限指令的安全性启示
* _内存管理单元——MMU（HYP-DV3）_：虚拟机监视器运行一种基于软件的内存管理单元（MMU），它为每个 VM 分配影子页表，由于客户 VM 不能被赋予对于基于硬件的 MMU 的直接访问权限，由于这可能会潜在地允许它们访问属于虚拟机监视器和其他共同托管的 VM （在某些情况下）的内存。然而，基于软件的 MMU 的错误实现可能导致任意地址空间的数据泄漏，诸如属于虚拟机监视器和共同托管的 VM 的内存段，因此导致内存隔离突破
* _输入/输出内存管理单元，IOMMU（HY-DV4）_：虚拟机监视器撬动硬件输入/输出内存管理单元以对使用直接内存访问（DMA）的设备驱动程序和进程强制实施内存隔离。此特性构建于虚拟机监视器之中，并且利用固件开关在硬件中启用。如果未被启用，它可能导致一种漏洞，在此，DMA 可以潜在地被某一 VM 用作普通攻击向量，以覆盖由其他 VM 和进程使用的物理内存

其中，漏洞 HYP-DV1 和 DYP-DV2 应该通过适当地编写代码和测试这些模块来解决。因此，没有安全性保护措施可以被应用于部署和使用阶段。然而，内存侵犯漏洞 HYP-DV3 和 DMA 侵犯漏洞 HY-DV4 可以通过在这样的硬件平台上托管虚拟机监视器来解决，此硬件平台分别通过对于虚拟化警觉的硬件内存管理单元和通过 DMA 传输重映射进行 DMA 传输来提供内存虚拟化辅助。由于这 2 种漏洞，威胁 HYP-T1，进程隔离突破，将会在第 4 章通过安全性建议 HY-SR-2 得到解决。

进一步地，正确执行隔离要求每一个 VM 获取其所托管的应用程序所必需的适当的内存和 CPU 资源，并且不会发生拒绝服务。通过适当的内存分配选项配置来保证足够的内存这一点将会通过安全性建议 HY-SR-3 得到解决。而通过 vCPU 分配选项的适当配置来保证适当的虚拟 CPU 分配这一点将会通过安全性建议 HY-SR-4 和 HY-SR-5 得到解决。

### 2.2.2 _针对 HY-BF2 的潜在威胁_

在 VM 中执行的应用程序需要访问诸如网络和存储设备。对设备访问的调度在虚拟机监视器宿主中通过设备虚拟化（也称为 IO 虚拟化）来处理。有 3 种常见的设备虚拟化方式：(a) 模拟，(b) 准虚拟化，和 (c) 透传或者自虚拟化的硬件设备。

在模拟中，代码被如此实现以呈现某个虚拟设备，它拥有与之对应的真实（硬件）设备，客户 OS 已经拥有它的驱动程序。这允许运行未经修改的客户（VM），由此实现完全虚拟化。模拟代码运行于虚拟机监视器中。来自客户 VM 应用程序（通过其客户 OS）的 I/O 调用被虚拟机监视器内核拦截，并且转发到此代码，由于客户 VM 在此设置之下不能直接访问物理设备。这也可以将来自客户 VM 的模拟虚拟设备的访问多路传输至底层物理设备。

在准虚拟化方式中，虚拟机监视器向客户呈现某个人工设备的某个接口，此设备没有相应的硬件对应体。这允许在客户上安装特定的，简化的，对虚拟机监视器警觉的 I/O 驱动程序（称为准虚拟化的驱动程序）。来自客户 VM 中的这些准虚拟化的设备驱动程序的调用由另一个设备驱动程序（称为后端驱动程序）来处理，这些驱动程序直接与物理设备交互，并且调度来自准虚拟化的客户到该物理设备的访问。在某些实例中，来自准虚拟化的客户驱动程序的调用直接由虚拟机监视器通过其超级调用接口（与之相对应的调用称为超级调用）来处理。对于由这些超级调用产生的威胁的分析将于下一节提供。

设备虚拟化的第 3 种方式，透传方式（或者直接设备指认）被部署于这样的情形，在此，由于性能的原因，某个 VM 需要对于某个设备（例如 NIC、硬盘控制器、主机总线适配器（HBA）、USB 控制器、串口、火线控制器、声卡等）的专属访问，以避免由于模拟造成的开销。由于这对于外设组件互连标准（PCI）设备来说通常是必需的，它因此也称为 PCI 透传。由于这些设备中的很多拥有内存映射的接口，它们可以直接读取或者写入主内存，并且因此被称为具有直接内存访问（DMA）能力的设备。为了提供 VM 对于具有 DMA 能力的设备的专属访问，此设备的内存页被映射到客户 VM 的地址空间。随之而来的是由于具有 DMA 能力的设备而造成的威胁。

_由于具有 DMA 能力的硬件设备而造成的威胁（HY-DV5）_：来自具有 DMA 能力的设备的安全性威胁在于，由于 VM 控制该设备，它可以编程该设备以执行 DMA 操作，指向任意物理（宿主）内存位置，包括属于其他 VM 或者虚拟机监视器的区域 \[6\]。因此，此类直接设备指认具有破坏 VM 之间的隔离（因而使得由 MMU 强制实施的隔离功能（作为 HY-BF1 的一部分）失去意义）的潜力。

除了上述 3 种类型的设备虚拟化之外，虚拟机监视器宿主还可以支持自虚拟化的硬件设备。这些设备拥有能够导出对应于某种物理功能（PF）的一组虚拟功能（VF）的接口。虚拟机监视器可以随后将这些 VF 指认给多个客户 VM，而它仍然保持对 PF 的控制。这些设备遵守单根 I/O 虚拟化（SR-IOV）规范，并且由此允许具有 DMA 能力的设备在 VM 之间共享（如同虚拟化和多路传输是由这些设备自身实现的）而非如同在透传模式中那样由单一 VM 专用。

### 2.2.3 _针对 HY-BF3 的潜在威胁_

上一节呈现了这样一种场景，即准虚拟化，在此，虚拟机监视器必须通过其超级调用接口执行特定指令。关于超级调用的一个潜在的安全性问题在于，缺少对于特定操作的适当的验证（例如，不会验证操作范围，并且因此允许对于 VM 的虚拟机控制块进行完整转储），可能潜在地导致整个虚拟机监视器宿主崩溃。这也是一种设计漏洞，必须通过适当的验证和对相关的虚拟机监视器代码进行测试，而非通过配置或者部署过程来解决。

### 2.2.4 _针对 HY-BF4 的潜在威胁_

对于此功能（即 VM 生命周期管理）之下的任务的安全执行的潜在威胁包括：

* 非标准 VM 镜像在库中的存在，包括那些具有过时的 OS 和补丁的镜像，这可能导致任何平台层级的威胁（HYP-T1～HYP-T3）
* 运行着的非标准 VM 实例的存在，由于其基于非标准镜像的创建、从快照恢复、由于监视中的疏忽而导致的对于标准的偏离，以及可能导致任何平台层级的威胁（HYP-T1～HYP-T3）的更新

在大多数实例中，对于 VM 的管理操作是利用通过 GUI 或者脚本环境提交的命令来执行的，二者均由位于后端的管理守护进程支持。上述操作的安全执行通过第 6 章的安全性建议 HY-SR9～HY-SR18 来解决。

### 2.2.5 _针对 HY-BF5 的潜在威胁_

此功能之下的任务与虚拟机监视器宿主（即虚拟化的宿主）和虚拟机监视器软件的整体管理相关联，并且通常是通过对用户友好的网页界面或者面向网络的虚拟控制台来执行的。针对这些任务的安全执行的威胁常见于任何远程管理，并且因此并未在此文档中解决。然而，具有虚拟化的宿主的数据中心中的核心要求是拥有对于虚拟机监视器的基于不同判据的统一配置，诸如基于一组托管的 VM 的应用程序的敏感度、业务线，或者云服务环境中的客户端等。因此，这些安全性建议包括一种对于虚拟机监视器配置的中心化管理（HY-SR-19）和一种用于管理流量的专用网段（HY-SR-20）。

某些传统的安全性修补方式对于托管虚拟机监视器的宿主而言可能并不可行。例如，对于针对未被虚拟化的物理服务器的网络攻击，只要关闭发动攻击的端口即可成为阻止该服务器利用机器人攻击向网络发送垃圾信息的解决方案。然而，这样的解决方案对于虚拟机监视器宿主来说并不可行，由于虚拟机监视器宿主的物理网卡的相同端口可能由若干运行着的 VM 所共享。因此，一种特殊的安全性修复，诸如禁用使用这些端口的 VM 的虚拟 NIC 是必需的。

