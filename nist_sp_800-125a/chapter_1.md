# 第 1 章 简介、范围和目标受众

虚拟机监视器是提供服务器虚拟化的核心软件。同它的支持模块一起，它允许所有硬件资源（例如 CPU、内存、网络和磁盘等）的虚拟化，并且因此允许多个计算栈（基本上是由 OS 和应用程序构成）运行在单一的物理宿主上。这样的物理宿主称为虚拟化宿主（在此文档中有时也称为虚拟机监视器宿主），独立的计算栈被封装在称为虚拟机（VM）的东西中。为了成为独立可执行的实体，VM 的定义应该包括分配给它的资源（例如 CPU、内存等）。VM 也称为“客户机”，而它们内部运行的操作系统（OS）称为“客户 OS”。与 VM 相关联的资源是虚拟资源，与同物理宿主相关联的物理资源相对。虚拟机监视器同这些支持模块以及托管硬件一同构成了虚拟机监视器平台。

虚拟机监视器的主要功能是强制执行客户 OS 隔离，以及客户 VM 之间的受控资源共享。因此它起到了传统 OS 对于非虚拟化的宿主（服务器）所起的作用中的很多。正如传统 OS 为运行在服务器上的不同应用程序（或者进程）之间提供隔离那样，虚拟机监视器为运行在其上的一台或者多台 VM 之间提供隔离。同样，类似于 OS，虚拟机监视器在多个 VM 之间调度其对物理资源（设备）的访问。尽管对于 CPU 和内存访问（以保证进程隔离）直接由虚拟机监视器处理（分别通过指令集（CPU）虚拟化和内存虚拟化，不论是否得到来自硬件的辅助），虚拟机监视器通过调用运行于内核之中的，或者称为设备驱动程序 VM 的专用 VM 之中的软件模块来处理对设备访问（设备虚拟化）的调度。虚拟机监视器可以直接安装在硬件或者裸机上（第 1 类虚拟机监视器），或者安装在称为宿主 OS 的完整传统 OS 上（第 2 类虚拟机监视器）。

初看起来，与虚拟机监视器及其硬件宿主（共同称为虚拟机监视器平台）的安全管理相关的所有活动可能看起来应该只是包含任何服务器级别的软件及其托管环境的已确立的最先进的技术实践。然而，仔细检查一下就会发现，用于支持虚拟机监视器所提供的硬件虚拟化的功能具有广泛的安全性后果，并且因此需要一组基于针对这些功能的完整性的威胁的分析的目标明确的安全性建议。在此文档中，这些功能称为虚拟机监视器的基线功能。

虚拟机监视器的基线功能包括：

* VM 进程隔离
* 设备调度和访问控制
* 来自客户 VM 的命令的直接执行
* VM 生命周期管理
* 虚拟机监视器平台的管理

对于上述功能的简略描述于下文 1.1 节给出。

## 1.1 虚拟机监视器的基线功能（HY-BF）

尽管虚拟机监视器的基本功能是虚拟化硬件（物理宿主）以允许运行多个虚拟宿主（普遍称之为 VM），商业虚拟机监视器供应带有不同的特性集合。提供相同特性集合的模块在不同的产品供应中被起了不同的名称。因此，为了达到此文档的目的，有必要定义一组虚拟机监视器的基线特性，它们能够涵盖用于支持硬件虚拟化的全部功能。在某些实例中，只是为 VM 提供一组虚拟化资源的模块称为虚拟机管理器（VMM）。如果 VMM 同提供 OS 层级服务的模块，诸如 CPU 中的 VM 计划相结合，它们便称为虚拟机监视器。虚拟机监视器的这些特性或者功能包括：

* _HY-BF1：VM 进程隔离_——提供 VM 执行计划，管理在 VM 中运行的应用程序进程，诸如 CPU 和内存管理，以及在 VM 中运行应用程序的过程中进行不同的处理器状态之间的上下文切换。为了保证 VM 进程隔离，来自支持直接内存访问（DMA）设备的内存访问需要受到虚拟机监视器的控制（例如通过输入输出内存管理单元（IOMMU））。然而，此功能被认为属于 HY-BF2，由于它属于设备调度。
* _HY-BF2：设备调度和访问控制_——使设备对于 VM 可用（例如通过模拟、准虚拟化、透传或者自虚拟化的硬件设备），并且控制哪些 VM 被允许访问哪些设备（例如网卡（NIC），诸如 IDE 驱动器的存储设备等）。
* _HY-BF3：来自客户 VM 的命令的直接执行_——某些来自客户 OS 的命令是由虚拟机监视器直接执行的，而非通过中断或者上下文切换而触发。此功能适用于那些实现了准虚拟化而非完全虚拟化的虚拟机监视器。
* _HY-BF4：VM 生命周期管理_——包括 VM 镜像的创建和管理、VM 状态的控制（开始、暂停、停止）、VM 迁移、制作快照、VM 监视，以及策略的强制执行等全部功能。
* _HY-BF5：虚拟机监视器平台的管理_——定义虚拟机监视器软件模块中的不同配置参数中的东西和设置值，包括适用于虚拟机监视器中的虚拟网络以及这些模块的更新和补丁的配置的东西和设置值。

关于这 5 种基线功能的简略描述足以指导此文档剩余部分的讨论。关于这些功能的详细讨论于附录 A 提供。

上述功能由不同的虚拟机监视器组件或者软件模块执行。在不同的虚拟机监视器产品之间，功能的分布方式存在一些次要差别。虚拟机监视器组件的这些功能以及这些组件的位置在总体的虚拟机监视器架构中的映射于下文的表格 1 中给出：

> 表 1：虚拟机监视器平台的基线功能

|基线功能|组件（软件模块）|位置|
|----|----|----|
|VM 进程隔离（HY-BF1）|虚拟机监视器内核|OS 内核（带有内核模块）本身，或者安装在完整 OS（宿主 OS）上的组件|
|设备调度和访问控制（HY-BF2）|设备模拟器或者设备驱动程序|专用 VM（称为设备驱动程序 VM）内部，或者虚拟机监视器内核自身内部|
|来自客户 VM 的命令的直接执行（HY-BF3）|虚拟机监视器内核|仅适用于准虚拟化的虚拟机监视器，并且由此类虚拟机监视器中的超级调用接口来处理|
|VM 生命周期管理（HY-BF4）|管理守护进程|安装在虚拟机监视器内核之上，但是运行于低权限模式|
|虚拟机监视器平台的管理（HY-BF5）|一组具有 CLI（命令行界面）或者 GUI（图形用户界面）的工具|运行在虚拟机监视器内核之上的控制台或者 shell|

一般来说，功能 HY-BF1 和 HY-BF3 由运行于内核中的共同称为“虚拟机监视器”的模块提供，而 HY-BF2 由运行于专用 VM（称为设备驱动程序 VM）或者虚拟机监视器内核自身之中软件模块启用。功能 HY-BF4 和 HY-BF5 由称为管理或者服务控制台的模块，或者通过内核模块执行。正如执行 HY-BF2 功能的模块那样，此控制台是一个软件层，它通常不是构建于虚拟机监视器内核之中，而是作为一个高权限 VM 运行于其上，并且可以由安装于其中的完整 OS 或者由用于为应用程序接口（API）（shell 和网络访问）提供实用程序功能的超轻量级 OS 构建，这些功能只是用于辅助执行虚拟机监视器特定的配置和管理任务。

## 1.2 此文档的范围

为服务器虚拟化而部署的虚拟机监视器的架构可以按照不同方式分类：

* (a) 基于虚拟机监视器所安装于其上的实体——第 1 类虚拟机监视器和第 2 类虚拟机监视器（已描述）
* (b) 基于虚拟化的类型
    * 完全虚拟化——虚拟机监视器将真实世界中存在的硬件设备的接口暴露出来，并且该设备的驱动程序对于客户 OS 可用，并且虚拟机监视器将会完全模拟该设备的行为。这种模拟允许 VM 中运行的程序使用 VM OS 的驱动程序，此驱动程序被设计为同被模拟的设备进行交互，而无需安装任何由虚拟机监视器厂商指定的特定驱动程序或工具。
    * 准虚拟化——虚拟机监视器将并不存在于真实世界中的设备暴露出来，它只是软件，并且带有轻量级的接口。然而，此种场景要求 VM 中具有特定的驱动程序，有时要求对客户 OS 进行修改。这种方式的本意是提升 VM 中运行的应用程序的性能水平，相对于完全虚拟化所采用的模拟方式而言。

此文档中所描述的虚拟机监视器平台所假设的信任模型如下所述：

* VM 中的所有组件均为不可信，包括客户 OS 及其运行于内核空间的相关实用工具（例如客户设备驱动程序）以及运行于用户空间的所有应用程序
* 虚拟机监视器平台内部实现的设备驱动程序不可信，除非它们带有安全证书
* 用于在 VM 之间提供隔离的虚拟机监视器内核组件可信
* 宿主 OS 对于第 2 类虚拟机监视器可信
* 虚拟机监视器宿主的硬件可信

有了关于虚拟机监视器架构的背景信息，以及假设的信任模型以后，对于 5 种基线功能（HY-BF1～HY-BF5）的安全性建议的范围涵盖下列方面：

* 与功能 HY-BF1、HY-BF2 和 HY-BF4 相关联的所有任务
* HY-BF3 与准虚拟化的虚拟机监视器的超级调用的处理相关联，它是虚拟机监视器的可信功能，并且并未包含于安全性建议中
* HY-BF5 之下的所有任务都被包括进来，除了与虚拟网络的定义和配置相关联的内容（虚拟网络的安全配置由另一篇 NIST 文档 SP800-125B 所涵盖）

同时提供了用于保证整体平台完整性的建议。

安全性建议并未涵盖下列内容：

* 虚拟机监视器宿主的用户帐户管理
* 虚拟机监视器宿主的认证和访问控制
* 宿主 OS 的程式化管理（例如保持补丁为最新）
* 客户 OS 的程式化管理
* 运行于 VM 上的客户 OS 的安全性
* 运行于 VM 上的应用程序/服务的安全性

## 1.3 目标受众

此文档中的安全性建议的目标受众如下：

* 想要开发虚拟化基础设施以便在虚拟机（VM）上托管不同的业务（LOB）应用程序系统的私人企业或者政府机构的企业 IT 部门的首席安全官（CSO）或者首席技术官（CTO）
* 想要提供虚拟化基础设施以便为云服务客户托管安全的云服务，诸如基础设施即服务（IaaS）的数据中心管理者

## 1.4 与其他 NIST 指南文档的关系

就技术领域而言，与此文档相关联的 NIST 指南文档是 NIST 特别出版（SP）800-125，_完全虚拟化技术安全性指南_。与当时的技术发展状态相一致（SP800-125 发布于 2011 年一月），SP800-125 为两种虚拟化应用范型：服务器虚拟化和桌面虚拟化中的组件应用提供了高级安全性建议。此后，服务器虚拟化在 IT 数据中心领域得到了广泛应用，既用于托管机构内部或者预先定制（企业）的应用程序，也用于为云服务托管应用程序以及提供计算单元。

伴随这一技术应用趋势而来的是虚拟机监视器的特性集合，以及用于配置和管理由虚拟机监视器衍生出来的虚拟化的基础设施的工具集合的市场可获得性的增加。此文档的目标是专注于一组用于虚拟机监视器（及其所有构成组件）的部署，包括 VM 的创建和供货所涉及的步骤的安全性建议的开发。此文档在类似的 NIST 指南文档的上下文环境中所提供的这组安全性建议的独特特性列于下方：

* 提供了一组目标明确的安全性建议，它们对于虚拟机监视器的部署是架构不可知的
* 由于真实世界中的部署过程包括 VM 供货，因此所有 VM 生命周期操作都被涵盖，从 VM 镜像的创建和管理到它们的使用粒度权限的管理
* 由于认识到虚拟机监视器是一种基于目的构建的操作系统（OS）内核，以及服务器 OS 的安全性取决于它的最弱一环这两点，无论其发行版（例如驱动程序软件），此文档也提供了与这些组件相关联的安全性建议
* 由于认识到虚拟机监视器会执行特定的高权限操作，而不会受到来自虚拟化的宿主中的任何其他实体的干涉，以及为这些操作撬动硬件支持将会为虚拟机监视器的部署的整体安全性带来显著差异这两点，这些安全性建议也会提升性能，如果虚拟化特定的功能（例如多个 VM 的内存表）被卸载（撬动）到处理器而非通过软件功能实现
* 所有安全性建议的本意是提供担保以对抗那些针对虚拟机监视器的基线功能所涉及的任务的威胁的利用

