# 附录 A 虚拟机监视器基线功能描述

关于 5 种虚拟机监视器基线功能中的每一种的详细描述提供如下：

* _HY-BF1：VM 进程隔离_——提供 VM 执行计划，管理在 VM 中运行的应用程序进程，诸如 CPU 和内存管理，以及在 VM 中运行应用程序的过程中进行不同的处理器状态之间的上下文切换。如果具有 DMA 能力的设备被用于虚拟机监视器宿主，这些设备的内存访问也需要被控制。然而，此功能被认为属于 HY-BF2，由于它属于设备调度。
* _HY-BF2：设备调度和访问控制_——使设备对于 VM 可用（例如通过模拟、准虚拟化、透传或者自虚拟化的硬件设备），并且控制哪些 VM 被允许访问哪些设备（例如网卡（NIC），诸如 IDE 驱动器的存储设备等）。
* _HY-BF3：来自客户 VM 的命令的直接执行_——某些来自客户 OS 的命令是由虚拟机监视器直接执行的，而非通过中断或者上下文切换而触发。此功能适用于那些实现了准虚拟化而非完全虚拟化的虚拟机监视器。
* _HY-BF4：VM 生命周期管理_——这涉及从 VM 镜像的创建和管理、VM 状态的控制（开始、暂停、停止）、VM 迁移、制作快照、VM 监视，到策略的强制执行等全部功能。
* _HY-BF5：虚拟机监视器平台的管理_——这涉及定义虚拟机监视器软件模块中的不同配置参数中的一些东西和设置值，包括适用于虚拟机监视器中的虚拟网络的配置的东西和设置值。

关于上述基线功能的详细描述如下：

## A.1 HY-BF1（VM 进程隔离）

提供 VM 执行计划，管理在 VM 中运行的应用程序进程，诸如 CPU 和内存管理，以及在 VM 中运行应用程序的过程中进行不同的处理器状态之间的上下文切换。为了保证 VM 进程隔离，来自支持 DMA 的设备的内存访问也需要受到虚拟机监视器的控制（例如通过 IOMMU）。然而，此功能被认为属于 HY-BF2，由于它属于设备调度。

## A.2 HY-BF2（设备调度和访问控制）

在 VM 中执行的应用程序需要访问诸如网络和存储设备。对设备访问的调度在虚拟机监视器宿主中通过设备虚拟化（也称为 IO 虚拟化）来处理。有 3 种常见的设备虚拟化方式：(a) 模拟，(b) 准虚拟化，和 (c) 透传或者自虚拟化的硬件设备。

在模拟中，代码被如此实现以呈现某个虚拟设备，它拥有与之对应的真实（硬件）设备，客户 OS 已经拥有它的驱动程序。这允许运行未经修改的客户（VM），由此实现完全虚拟化。模拟代码运行于虚拟机监视器中。来自客户 VM 应用程序（通过其客户 OS）的 I/O 调用被虚拟机监视器内核拦截，并且转发到此代码，由于客户 VM 在此设置之下不能直接访问物理设备。这也可以将来自客户 VM 的模拟虚拟设备的访问多路传输至底层物理设备。

在准虚拟化方式中，虚拟机监视器向客户呈现某个人工设备的某个接口，此设备没有相应的硬件对应体。这允许在客户上安装特定的，简化的，对虚拟机监视器警觉的 I/O 驱动程序（称为准虚拟化的驱动程序）。来自客户 VM 中的这些准虚拟化的设备驱动程序的调用由另一个设备驱动程序（称为后端驱动程序）来处理，这些驱动程序直接与物理设备交互，并且调度来自准虚拟化的客户到该物理设备的访问。在某些实例中，来自准虚拟化的客户驱动程序的调用直接由虚拟机监视器通过其超级调用接口（与之相对应的调用称为超级调用）来处理。

设备虚拟化的第 3 种方式，透传方式（或者直接设备指认）被部署于这样的情形，在此，由于性能的原因，某个 VM 需要对于某个设备（例如 NIC、硬盘控制器、HBA、USB 控制器、串口、火线控制器、声卡等）的专属访问，以避免由于模拟造成的开销。通常，这对于 PCI 设备来说通常是必需的，并且因此也称为 PCI 透传。由于这些设备中的很多拥有内存映射的接口，它们可以直接读取或者写入主内存，并且因此被称为具有直接内存访问（DMA）能力的设备。为了提供 VM 对于具有 DMA 能力的设备的专属访问，此设备的内存页被映射到客户 VM 的地址空间。

除了上述 3 种类型的设备虚拟化之外，虚拟机监视器宿主还可以支持自虚拟化的硬件设备。这些设备拥有能够导出对应于某种物理功能（PF）的一组虚拟功能（VF）的接口。虚拟机监视器可以随后将这些 VF 指认给多个客户 VM，而它仍然保持对 PF 的控制。这些设备遵守单根 I/O 虚拟化（SR-IOV）规范，并且由此允许具有 DMA 能力的设备在 VM 之间共享（如同虚拟化和多路传输是由这些设备自身实现的）而非如同在透传模式中那样由单一 VM 专用。

## A.3 HY-BF3（来自客户 VM 的命令的直接执行）

某些来自客户 OS 的命令是由虚拟机监视器直接执行的，而非通过中断或者上下文切换而触发。这些命令称为超级调用，并且由虚拟机监视器中的特殊接口支持。此功能仅适用于那些实现了准虚拟化而非完全虚拟化的虚拟机监视器。

## A.4 HY-BF4（VM 生命周期管理）

这包括 VM 上的所有管理操作，贯穿其生命周期。它们包括但不限于：

* 遵守标准镜像的 VM 创建，保证镜像的完整性并且保护镜像的存储和获取过程；供应具有适当的 vCPU、内存、网络和存储的镜像
* 将 VM 从一个虚拟机监视器宿主迁移到另一个
* 监视 VM 执行与出入流量，以及总体配置管理
* 对于 VM 管理的精细粒度访问控制，包括改变 VM 状态的基本操作——启动、暂停、停止
* 快照的访问控制和管理

管理任务通过利用提供了网络接口的管理守护进程而实现。_这些接口通常不是作为虚拟机监视器内核模块的一部分，而是在高权限 VM（管理 VM）上实现，它作为虚拟机监视器平台启动过程的一个组成部分而启动。_

## A.5 HY-BF5（虚拟机监视器平台管理）

这些任务包括虚拟机监视器宿主（虚拟化的宿主）和虚拟机监视器软件本身的配置所涉及的任务。重要的任务包括：将 VM 供应至虚拟机监视器宿主，创建和管理虚拟机监视器集群，以及配置虚拟机监视器宿主内部的虚拟网络。虚拟网络是虚拟机监视器宿主内部的由软件定义的网络，它允许 VM 之间的连接性，以及 VM 到外部网络（例如 LAN、WAN 等）的连接性。

# 附录 B 关于虚拟机监视器的基线功能的安全性建议的可溯源性

|编号|安全性建议|基线功能|
|----|----|----|
|HY-SR-1|所启动的虚拟机监视器应该成为平台以及整体基础设施的一部分，它包括：(a) 具有基于标准的密码学测定能力和存储设备的支持 MLE 的硬件，以及 (b) 应该具有能力以利用这些来提供一条从硬件开始直到所有虚拟机监视器组件的信任链的证明过程。被测定的元素（组件）至少应该包括下列：核心内核、内核支持模块、设备驱动程序，以及虚拟机监视器的原生管理应用程序（用于 VM 生命周期管理和虚拟机监视器管理）。信任链应该为所有被测定的组件未被破坏并且它们的版本正确（即整体启动完整性）提供担保。如果信任链将要被延伸至客户 VM，虚拟机监视器应该提供一个虚拟接口到基于硬件的 MLE。|无|
|HY-SR-2|虚拟化的宿主的硬件应该利用 MMU 对指令集虚拟化和内存管理提供辅助，由于硬件支持提供了下列安全性担保，而这些是完全基于软件的虚拟化所不能保证的：<br/>* 更佳的内存管理控制可以防止诸如缓冲区溢出等攻击<br/>* IOMMU 中的 DMA 传输重映射特性提供更佳的 I/O 设备隔离。更进一步地，直接将 I/O 设备指认给某个特定 VM 并且允许直接访问这些资源这一特性消除了为该 VM 提供模拟设备驱动程序的需求，因此减少了可信代码的大小<br/>* 客户 OS 代码和虚拟机监视器代码执行于不同的处理器模式，提供了更佳的隔离<br/>* 权限层级的隔离可以为设备访问调度功能提供更佳的保护，并且硬件层级的内存保护可以提供更佳的 VM 层级保护<br/>* 通过支持完全虚拟化，COTS 版本的 OS 可以允许更简单的补丁和更新，而非必须对可以运行于准虚拟化平台的唯一类型的修改或者移植版本的 OS 进行相同操作<br/>* 由于现在众多虚拟化特性在硬件中可用，虚拟机监视器代码将会变小，允许更佳的安全性证明和验证|HY-BF1（VM 进程隔离）|
|HY-SR-3|虚拟机监视器应该拥有配置选项以便为每一个（要求内存的）VM 指定保证的物理内存量，以及该值的上限，并且指定一个优先级的值，以用于在多个 VM 之间产生竞争的条件下获取必需的内存资源。更进一步地，允许所有 VM 的配置内存总量超过宿主的物理内存的内存超量使用特性（如果可用）应该默认禁用。|HY-BF1（VM 进程隔离）|
|HY-SR-4|虚拟机监视器应该拥有强壮的配置特性以便以这样的方式将虚拟资源提供给所有托管的 VM，即它不会超过某种关键物理资源（例如 CPU 内核数量）|HY-BF1（VM 进程隔离）|
|HY-SR-5|虚拟机监视器应该提供特性以便为每一个部署的 VM 所需的 CPU 时钟周期指定下限和上限，以及提供特性以便为每一个 VM 指定一个优先级分值，以便在多个 VM 竞争 CPU 资源的情况下辅助计划|HY-BF1（VM 进程隔离）|
|HY-SR-6A，HY-SR-6B，HY-SR-6C|_安全性建议 HY-SR-6A（模拟）_：由于通过软件模拟硬件的复杂性，模拟方式除了受到性能损失以外，还会增加 TCB 的大小，特别是在客户 OS 拥有原生设备驱动程序并且设备模拟代码作为内核模块运行在和虚拟机监视器相同的权限层级的情况下。因此，模拟应该仅被应用于这种复杂性可控时（例如 USB 主机控制器）<br/>_安全性建议 HY-SR-6B（准虚拟化）_：在准虚拟化的设备驱动程序被用于 VM 中的情况下，对物理设备的访问的调度应该通过在专用 VM 而非在虚拟机监视器中运行后端设备驱动程序（它们控制着连接到虚拟机监视器宿主的物理设备）来启用。这有助于使得后端设备驱动程序代码运行在低于虚拟机监视器的权限层级上。此外，虚拟机监视器平台应该包括输入/输出内存管理单元（IOMMU）形式的硬件支持以便验证并且翻译从驱动程序域的底层硬件设备到宿主内存的访问。强制性的具体 IOMMU 特性包括 DMA 重映射，在此，从设备到客户物理地址（GPA）的 DMA 调用必须被翻译到宿主物理地址（HPA），并且随后被检查该 HPA 地址是否落在指认给该设备的保护域内。结合这些机制可以减少 TCB 的大小，并且降低错误的设备或者设备驱动程序的行为的影响（限制在设备驱动程序 VM 范围内，而非虚拟机监视器）<br/>_安全性建议 HY-SR-6C（透传或者自虚拟化的硬件设备）_：对于 VM 需要被赋予对具有 DMA 能力的设备的专用访问权限的情况，虚拟机监视器平台应该包括输入/输出内存管理单元（IOMMU）形式的硬件支持以便验证并且翻译所有设备对宿主内存的访问。此建议也适用于启用虚拟化的硬件设备的使用（基于 SR-IOV 规范）。强制性的具体 IOMMU 特性包括 DMA 重映射，在此，从设备到客户物理地址（GPA）的 DMA 调用必须被翻译到宿主物理地址（HPA），并且随后被检查此 HPA 是否落在指认给该设备的保护域内|HY-BF2（设备调度和访问控制）|
|HY-SR-7|应该可能设置访问控制列表（ACL）以便将每一个 VM 进程的访问权限限制为仅对指认给该 VM 的设备。为了实现这一点，虚拟机监视器配置应该支持某种特性以标识（标记） VM（从语义上讲，一组任务），并且/或者拥有某种特性以便为每一个 VM 指定一组设备白名单（被允许的设备列表）|HY-BF2（设备调度和访问控制）|
|HY-SR-8|应该可能为每一个 VM 的网络带宽和 I/O 带宽（例如硬盘读/写速度）设置资源限制以防止拒绝服务（DOS）攻击。更进一步地，对资源限制的适当使用可以使得 DOS 攻击对定义了资源限制的 VM 或者集群的影响定域化|HY-BF2（设备调度和访问控制）|
|HY-SR-9|必须为所有类型的 VM 定义黄金标准，并且不符合此标准的 VM 镜像不应该被允许存储到 VM 镜像服务器或者库中。更进一步地，VM 镜像库中的镜像应该被周期性地扫描以查找将要过时并且因此偏离标准的 OS 版本和补丁|HY-BF4（VM 生命周期管理）|
|HY-SR-10|存储于镜像服务器中的每一个 VM 镜像应该带有数字签名以作为合法性和完整性的标识，利用可信、强壮的密码学密钥签名|HY-BF4（VM 生命周期管理）|
|HY-SR-11|向 VM 镜像库中迁入或者从中迁出镜像的许可应该通过某种强壮的访问控制机制强制实施，并且限制在一组授权的管理员中。如果没有访问控制机制，VM 镜像文件应该存储于加密设备中，该设备只能由一组限定的授权管理员利用具有足够复杂度的口令打开/关闭|HY-BF4（VM 生命周期管理）|
|HY-SR-12|对存储 VM 镜像的服务器的访问应该总是通过安全协议，诸如 TLS|HY-BF4（VM 生命周期管理）|
|HY-SR-13|在 VM 即时迁移过程中，应该谨慎以确保安全认证协议被用于执行即时迁移；执行迁移操作的管理员的凭证只被传输至目标宿主；内存内容和处理器状态的迁移通过安全网络连接进行；并且一个专用虚拟网段被同时用于源和目标宿主以承载此流量|HY-BF4（VM 生命周期管理）|
|HY-SR-14|应该存在机制以用于安全监视、VM 操作安全策略强制实施——对于 VM 中运行的恶意进程和出入 VM 的恶意流量。此监视和强制实施机制构成了用于构建杀毒（AV）和入侵检测及防止系统（IDPS）解决方案的基础|HY-BF4（VM 生命周期管理）|
|HY-SR-15|用于 VM 的安全监视和安全策略强制实施解决方案应该基于“VM 外部”，并且应该撬动虚拟机监视器的虚拟机自省能力。通常，这样的解决方案涉及在安全加固的或者可信 VM 中运行诸如安全虚拟设备（SVA）的安全工具|HY-BF4（VM 生命周期管理）|
|HY-SR-16|运行于虚拟机监视器宿主中的所有反恶意软件工具（查毒软件、防火墙和 IDPS 等）应该拥有能力以执行基于一定周期的自主签名或者索引文件更新|HY-BF4（VM 生命周期管理）|
|HY-SR-17|VM 配置管理工具应该具有能力以编译日志并且警示管理员，如果在被监视的任何 VM 中检测到配置更改|HY-BF4（VM 生命周期管理）|
|HY-SR-18|用于 VM 管理的访问控制解决方案应该拥有粒度能力，既在权限授予层级，也在对象层级（即对于权限目标的具体说明可以是单一 VM 或者任何 VM 的逻辑组合——基于功能或者位置）。此外，还应该存在这样的能力以禁止对于某个 VM 组（例如运行具有特定敏感度等级的负载的 VM）中的某些特别对象的权限，尽管其拥有对于该 VM 组的访问权限|HY-BF4（VM 生命周期管理）|
|HY-SR-19|对于企业中安装的所有虚拟机监视器的管理应该利用企业虚拟化管理系统（EVMS）以中心化的方式实现。更进一步地，用于不同类型的负载和集群的企业黄金标准虚拟机监视器配置必须通过 EVMS 进行管理（强制实施）。此黄金标准配置至少应该覆盖下列方面——CPU、内存、存储、网络带宽，以及（如有必要）宿主 OS 加固|HY-BF5（虚拟机监视器平台管理）|
|HY-SR-20|对于虚拟机监视器宿主和软件管理功能的保护应该通过分配一块专用的物理 NIC 来保证，如果这不可行，则改为将虚拟机监视器的管理接口置于专用的虚拟网段中，并且利用防火墙强制实施流量控制（例如，在企业网络中指定子网，从这些子网到管理接口的流入流量被允许）|HY-BF5（虚拟机监视器平台管理）|

# 附录 C 用语

* 完全虚拟化——一种形式的虚拟化，其中，虚拟机监视器呈现的虚拟化资源反映了底层硬件的架构，因此未经修改的客户 OS 可以在其上运行
* 客户操作系统（OS）——虚拟机（见下）执行栈中的操作系统组件，其他组件包括虚拟硬件、中间件和应用程序
* 虚拟机监视器——利用某种特殊的 OS 内核以及支持性的内核模块构建的软件，这些内核模块为虚拟机（见下）所呈现的不同执行栈提供隔离
* 虚拟化的宿主——诸如虚拟机监视器等虚拟化软件所安装于其上的物理宿主。通常，虚拟化的宿主将会包含特别硬件平台以辅助虚拟化——特别是指令集和内存虚拟化
* 虚拟机（VM）——由软件定义的完整的执行栈，由虚拟化的硬件、操作系统（客户 OS）和应用程序构成
* 虚拟化——用于硬件资源模拟或者抽象化的方法，以允许完整的执行栈，包括软件应用程序，在其上运行

# 附录 D 参考文献

* 1. _Mastering VMware vSphere 5.5_, Scott Lowe et al., Wiley Publishing Incorporated (2013)
* 2. _Running Xen: A Hands-On Guide to the Art of Virtualization_, J.N. Matthews et al., Prentice Hall (2008)
* 3. _Building the Infrastructure for Cloud Security: A Solutions View_, R.Yeluri, and E.Castro-Leon, Apress Media/Springer Science (2014)
* 4. _Trusted Platform Module (TPM) Main Specification_: [http://www.trustedcomputinggroup.org/resources/tpm_main_specification](http://www.trustedcomputinggroup.org/resources/tpm_main_specification)
* 5. S.Shirinbab, L. Lundberg and D. Ilie, _Performance Comparison of KVM, VMware and Xenserver using a Large Telecommunication Application, Proceedings of the Fifth International Conference on Cloud Computing, GRIDs, and Virtualization (CLOUD COMPUTING)_, 2014. [http://bth.diva-portal.org/smash/record.jsf?pid=diva2%3A834000](http://bth.diva-portal.org/smash/record.jsf?pid=diva2%3A834000)
* 6. E. Bugnion, J. Nieh and D. Tsafrir, Hardware and Software Support for Virtualization,

