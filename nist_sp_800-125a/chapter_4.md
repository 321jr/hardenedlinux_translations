# 第 4 章 HY-BF1 安全性建议

为了保证 VM 中运行的进程的隔离，下列要求必须被满足：

* (a) 从客户 OS 到宿主处理器的高权限命令或者指令必须被调度，以使得 VMM/虚拟机监视器作为虚拟化资源控制器的基本功能得以维持
* (b) 虚拟机监视器宿主的内存管理功能的完整性必须被保护，以防止诸如缓冲区溢出以及非法代码执行等攻击，特别是在存在管理多个 VM 的内存访问所必需的翻译表的情况下
* (c) 内存分配算法必须保证所有 VM 中的负载都能够执行它们的功能
* (d) CPU 分配算法必须保证所有 VM 中的负载都能够执行它们的功能

要求 (a) 和 (b) 可以利用基于软件的模块来满足。然而，相对于基于软件的解决方案，诸如指令集虚拟化和内存虚拟化等基于硬件的虚拟化辅助对于满足这些要求能够提供更多的担保，因而在 4.1 节中被推荐。在表述推荐之前，先简要地讨论一下基于硬件地虚拟化特性。要求 (c) 和 (d) 本意是要保证 VM 中运行的应用程序服务的可用性。用于提供这些保障的是内存分配和 CPU 分配算法中的某些特性，并且与之相关联的配置参数分别在 4.2 和 4.3 节中被表述为推荐。

## 4.1 硬件虚拟化辅助

_指令集虚拟化_：用于支持指令集虚拟化的处理器架构提供两种操作模式：root 模式和非 root 模式，每一种都有 4 个层级的权限等级，其中 0 级为最高而 3 级为最低。此外，在这两种模式中，对于执行 CPU 指令，root 模式比非 root 模式具有更高权限。通过在 root 模式中运行虚拟机监视器，并且在高权限或者 0 环的非 root 模式中运行 VM（客户）OS，虚拟机监视器的安全得以保证，至少是通过防止来自任意客户 OS 的任何指令集类型的攻击。然而，VM 逃逸可能通过正常的网络协议而发生。此安全性是通过允许硬件捕获高权限指令以在非 root 模式中运行而在 root 模式中执行而得到保证的。此外，如果虚拟机监视器不必须执行额外的功能（例如利用诸如二进制翻译等技术翻译敏感指令），在虚拟机监视器中以高权限执行的代码将会减少，使得 TCB 更小，并且允许更好的担保验证。

_内存虚拟化_：如果硬件允许利用基于硬件的页表而非由虚拟机监视器生成的影子页表将客户 OS 在其对应页表中的物理地址映射到宿主的物理地址，则称提供了硬件辅助的内存虚拟化。由此引起的用于执行此功能的高权限代码的减少可以提供相当于上述指令集虚拟化部分所提到的安全性优势。

硬件辅助的虚拟化平台的安全性优势包括以下方面：

* 虚拟机监视器的潜在安全漏洞之一是来自驻留于虚拟化的宿主平台上的 VM 的缓冲区溢出攻击。作为硬件辅助虚拟化的一部分的内存管理（例如扩展页表，PET）的硬件支持可以被撬动以防止来自保留给数据存储的内存位置的代码执行，因此阻止缓冲区溢出攻击
* 虚拟化的硬件扩展提供了两种执行模式：宿主或者 root 模式，以及客户或者非 root 模式。宿主模式运行在高于客户模式的权限等级上。提供基线功能 HY-BF1（处理器分配和内存管理）的虚拟机监视器代码运行于宿主模式而 VM 中的客户 OS 和应用程序运行于客户模式。因此客户 OS 中的任何漏洞利用代码不能破坏由虚拟机监视器代码提供的控制
* 虚拟化平台中的一种常见威胁涉及能够访问属于其他 VM 的内存区域的恶意 VM。这称为 VM 逃逸攻击。具有 IOMMU 的硬件平台提供了针对这种威胁的安全性，通过诸如直接内存访问（DMA）重映射等特性，这将被允许的 DMA 访问限制在指定的保护域中（即阻止设备执行超出其分配区域的 DMA）
* 为两种形式的虚拟化提供硬件辅助的优势在于，虚拟机监视器中的模拟模块可以呈现物理宿主的真实硬件架构而非修改过的硬件架构。这一特性的结果是，未经修改的客户 OS 及其原生设备驱动程序可以运行在 VM 中。启用这一特性的安全性启示是，多得多的 CVE 数据可用于客户 OS，而对于每一种 OS 版本的补丁版本以及认证的设备驱动程序也会多得多

_安全性建议 HY-SR-2_：虚拟化的宿主的硬件应该利用 MMU 对指令集虚拟化和内存管理提供辅助，由于硬件支持提供了下列安全性担保，而这些是完全基于软件的虚拟化所不能保证的：

* 更佳的内存管理控制可以防止诸如缓冲区溢出等攻击
* IOMMU 中的 DMA 传输重映射特性提供更佳的 I/O 设备隔离。更进一步地，直接将 I/O 设备指认给某个特定 VM 并且允许直接访问这些资源这一特性消除了为该 VM 提供模拟设备驱动程序的需求，因此减少了可信代码的大小
* 客户 OS 代码和虚拟机监视器代码执行于不同的处理器模式，提供了更佳的隔离
* 权限层级的隔离可以为设备访问调度功能提供更佳的保护，并且硬件层级的内存保护可以提供更佳的 VM 层级保护
* 通过支持完全虚拟化，COTS 版本的 OS 可以允许更简单的补丁和更新，而非必须对可以运行于准虚拟化平台的唯一类型的修改或者移植版本的 OS 进行相同操作
* 由于现在众多虚拟化特性在硬件中可用，虚拟机监视器代码将会变小，允许更佳的安全性证明和验证

## 4.2 VM 内存分配计划选项

虚拟机监视器的内存调度程序负责在任何时间使得所有 VM 中运行着的所有负载满足其内存要求。类似于 OS，常见的虚拟机监视器利用物理内存和称为虚拟机监视器内核交换文件的交换文件来满足这一要求。更进一步地，常见的 VM 并不总是要求它所被配置的全部内存。基于这些原因，使得运行在某个虚拟化的宿主上的 VM 的配置内存总量超过物理内存总量是一种可能实现的总体虚拟化配置决策，如果 VM 中没有运行内存敏感的应用程序。然而，内存超量使用——即 VM 的配置内存总量和宿主的物理内存的比例——不应过高，由于这可能导致某些要求大量内存的 VM 负载的性能恶化。

对于 VM 中的某些负载，影响虚拟化的宿主或者虚拟机监视器的可用性的另一个因素是物理内存大小和由虚拟机监视器的内存调度程序维护的内核交换文件大小的比例。由于过低的比例将会拒绝某些 VM 中的某些负载的执行，虚拟机监视器中应该有一个配置选项以便为每个 VM 指定一个保证的物理内存量。同样，为了避免这样一种情形，即某个特定 VM 占用了相当于它的全部配置内存的物理内存，应该有一个特性以指定保证的物理内存的上限。最后，可能有某些负载是时间敏感的，则托管它们的 VM 应该相对于其他运行着的 VM 在获得必需的内存资源方面具有一定的优先级。因此，还应该存在一个配置选项以便为每一个 VM 指定一个优先级的值。

基于上述与虚拟机监视器的内存计划相关的问题，下面就是安全性建议：

_安全性建议 HY-SR-3_：虚拟机监视器应该拥有配置选项以便为每一个要求内存的 VM 指定保证的物理内存量，以及该值的上限，此外还有在多个 VM 之间产生竞争的条件下用于获取必需的内存资源的优先级的值。更进一步地，允许所有 VM 的配置内存总量超过宿主的物理内存的内存超量使用特性应该默认禁用。

## 4.3 VM CPU 分配选项

VM CPU 分配的安全性目标是保证所有 VM 的可用性。这可以通过对于处理诸如 CPU 内核和 CPU 时钟周期等物理资源的分配的配置选项的适当使用来实现。例如，一个普遍可用的配置选项是设置最小 CPU 要求，或者预留，以时钟周期计算。这里需要遵守的架构参数是，可以被部署的 VM 数量不能超过虚拟机监视器宿主可以提供的 CPU 时钟周期总数和每个 VM 要求的平均预留的比值。例如这样的场景，虚拟机监视器宿主拥有 6000 MHz 的 CPU 能力，而每一个 VM 所要求的平均预留为 1000 MHz，那么该虚拟机监视器宿主上不能有多于 6 个 VM 处于活动状态。因此，预留为每个 VM 所要求的 CPU 时钟周期设置了下限（保证）。类似地，还应该有一个特性来为每一个 VM 所能够使用的 CPU 周期设置上限，或者限制，以使得没有一个 VM（有时是恶意或者受到攻击的 VM）会消耗宿主的全部 CPU 资源并且对与之共同驻留的 VM 拒绝服务。更进一步地，为了在这样一种情况下辅助计划虚拟机监视器宿主的 CPU 时钟周期，即多个 VM 要求的时钟周期高于下限但是低于上限，应该有一个特性来为每一个 VM 指认一个优先级分值，或者份额。综合以上关于保证所有部署的 VM 之间的合理分配的理想特性，关于 VM CPU 分配的安全性建议如下所述：

_安全性建议 HY-SR-4_：虚拟机监视器应该拥有强壮的配置特性以用于将虚拟资源提供给所有托管的 VM，以使得它不会超过某种关键物理资源（例如 CPU 内核数量）

_安全性建议 HY-SR-5_：虚拟机监视器应该提供特性以便为每一个部署的 VM 所需的 CPU 时钟周期指定下限和上限，以及提供特性以便为每一个 VM 指定一个优先级分值，以便在多个 VM 竞争 CPU 资源的情况下辅助计划

