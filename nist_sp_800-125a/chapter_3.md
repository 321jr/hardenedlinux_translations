# 第 3 章 针对整体平台完整性的安全性建议

配置更改、模块版本变化，以及补丁将会影响虚拟机监视器平台组件的内容，诸如 BIOS、虚拟机监视器内核，以及运行于内核中的后端设备驱动程序。为了保证作为虚拟机监视器栈的组成部分的这些组件中的每一个都可信，有必要通过某种能够提供启动完整性的担保的，植根于硬件的证明机制来检测它们的完整性。完整性检测是通过以密码学的方式来认证所启动的虚拟机监视器组件来实现的。这种认证方式验证只有授权的代码可以在系统上运行。具体地，在虚拟机监视器的上下文环境中，这种完整性证明可以防止破坏以及诸如 rootkit 的低级目标性攻击。如果此完整性证明被推迟到某个具有可信权力的作用的可信第三方，此验证过程被称为 _可信证明_。可信证明提供对于此虚拟机监视器组件的代码未被破坏的证明。在此方式中，对于虚拟机监视器组件的信任是建立在可信硬件的基础之上的。换言之，一条从硬件到虚拟机监视器的信任链是建立在称为 _可信根_ 的首个组件之上的。此服务可以由支持启动完整性测定和证明过程的虚拟机监视器宿主的硬件/固件基础设施来提供。简言之，测定启动环境（MLE）是虚拟机监视器宿主所必需的。

某些硬件平台利用用于测定启动序列中的组件的完整性（通常是二进制代码的散列值）的固件例程来提供对于 MLE 的支持。实施了测定启动过程的基于硬件的密码学存储模块的一个范例是基于标准的可信平台模块（TPM），它已经由可信计算小组（TCG）标准化 \[4\]。TPM 的 3 个主要组件包括：(a) 测定可信根（RTM）——进行完整性测定（通常是密码学散列值）并且将其转换为证明，(b) 完整性可信根（RTI）——提供受保护的存储、完整性保护，以及受保护的接口以存储和管理证明，以及 (c) 报告可信根（RTR）——提供受保护的环境和接口以管理身份并且签名证明。RTM 沿着启动序列测定下一段代码。此测定结果被存储在称为平台配置寄存器（PCR）的特定寄存器中。

在此，以 TPM 为例简单解释测定启动过程。测定启动过程始于在 BIOS 中执行一段可信的不可变代码，它同样会测定将要执行的下一段代码。在将控制权移交给序列中的下一个程序之前，此测定结果被扩展到 TPM 中的 PCR。由于序列中的每一个组件在移交控制权之前依次测定下一个组件，一条信任链被建立起来。如果测定链持续贯穿整个启动序列，则由此产生的 PCR 值反映了所有组件的测定结果。

证明过程始于请求者调用，通过宿主上的代理，TPM 引用命令。它指定一个证明识别密钥（AIK）以执行对于一组 PCR 的内容的数字签名，该组 PCR 包括启动序列中的所有欲引用的组件的测定结果，以及一个密码学临时随机数以保证数字签名的新鲜度。在接收到签名的引用之后，请求者验证签名并且通过比较 TPM 引用中的测定结果和已知良好的测定结果来决定是否信任所启动的组件。

MLE 可以以如下方式整合到虚拟机监视器宿主中：

* 托管虚拟机监视器的硬件被建立为可信根，一条始于硬件贯穿 BIOS 直到所有虚拟机监视器组件的信任链被建立起来
* 对于想要被建立为可信根并且构建信任链的由处理器和芯片组构成的硬件，它应该拥有支持 MLE 的基于硬件的模块。在支持 MLE 的硬件中启动虚拟机监视器的结果是固件、BIOS，以及虚拟机监视器（内核）模块的全部或者某个关键子集的测定启动，因此构成了从硬件到虚拟机监视器的信任链
* 虚拟机监视器供应必须能够利用 MLE 特性。换言之，虚拟机监视器应该能够调用安全启动过程，这通常是通过向虚拟机监视器的代码库中整合一个前内核模块来实现的，由于内核是在虚拟机监视器启动过程中首个被安装的模块。这个前内核模块的目的是保证选择硬件中的正确的经过认证的模块，该模块对虚拟机监视器中启动的组件或者该硬件上启动的任何软件执行有序的评估或者测定。Tboot 是这样的机制的一个范例，它允许虚拟机监视器利用硬件的 MLE 特性
* 想要成为可信计算基（TCB）的一部分的所有虚拟机监视器组件必须被包括在启用 MLE 机制的范围内，以使得它们作为其启动过程的一部分而被测定

可以撬动虚拟化的宿主的硬件上的带有存储和报告机制的 MLE 特性以提供虚拟机监视器组件的启动完整性担保，通过测定启动序列中的所有实体的身份，从固件开始，然后是 BIOS、虚拟机监视器，以及虚拟机监视器模块，将其与“已知良好值”进行比较；并且报告任何不相符之处。如果该测定启动过程将要被延伸以覆盖 VM 及其内容（客户 OS 和应用程序），在虚拟机监视器内核中的对于基于硬件的 MLE 实现的基于软件的扩展是必需的。现在，对于保证虚拟机监视器平台的所有组件的安全启动过程的安全性建议可以叙述如下：

_安全性建议 HY-SR-1_：所启动的虚拟机监视器应该成为平台以及整体基础设施的一部分，它包括：(a) 具有基于标准的密码学测定能力和存储设备的支持 MLE 的硬件，以及 (b) 具有提供一条从硬件开始直到所有虚拟机监视器组件的信任链的能力的证明过程。更进一步地，被测定的元素至少应该包括核心内核、内核支持模块、设备驱动程序，以及虚拟机监视器的用于 VM 生命周期管理和虚拟机监视器管理的原生管理应用程序。信任链应该为所有被测定的组件未被破坏并且它们的版本正确（即整体启动完整性）提供担保。如果信任链将要被延伸至客户 VM，虚拟机监视器应该提供一个虚拟接口到基于硬件的 MLE。

